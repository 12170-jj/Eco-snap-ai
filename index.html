<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eco Snap AI üåø</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #77dd77; --secondary: #ffb7b2; --accent: #fdfd96; --bg: #f4faf6; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Kanit', sans-serif; margin: 0; background-color: #e0f2f1; display: flex; justify-content: center; }
        #app { width: 100%; max-width: 500px; min-height: 100vh; background: var(--bg); display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .page { padding: 20px; flex: 1; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        .btn { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 20px; font-size: 18px; font-weight: 600; cursor: pointer; width: 100%; margin: 10px 0; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-secondary { background: #84b6f4; }
        .btn-back { width: auto; padding: 8px 15px; background: var(--secondary); font-size: 14px; border-radius: 12px; color: white; border:none; margin-bottom: 20px; align-self: flex-start; }
        input, select { width: 100%; padding: 15px; margin: 8px 0; border-radius: 15px; border: 2px solid #c8e6c9; font-size: 16px; font-family: 'Kanit'; outline: none; }
        .upload-zone { width: 100%; height: 280px; border: 4px dashed var(--primary); border-radius: 30px; margin: 15px 0; overflow: hidden; background: #fff; display: flex; align-items: center; justify-content: center; position: relative; }
        #webcam, #img-preview { width: 100%; height: 100%; object-fit: cover; }
        .result-card { background: white; border: 4px solid var(--primary); border-radius: 25px; padding: 20px; text-align: center; margin: 15px 0; }
        .history-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .history-card { background: white; border-radius: 20px; overflow: hidden; border: 1px solid #eee; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .history-card img { width: 100%; height: 110px; object-fit: cover; }
        .history-info { padding: 8px; font-size: 11px; line-height: 1.4; }
        .score-row { background: white; padding: 18px; border-radius: 20px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #f0f0f0; }
    </style>
</head>
<body>

<div id="app">
    <div id="role-page" class="page" style="justify-content:center; text-align:center;">
        <div style="font-size: 70px;">üåø</div>
        <h1 style="color:#2d6a4f; margin:10px 0;">Eco Snap AI</h1>
        <p style="color:#666; margin-bottom:30px;">‡∏Ñ‡∏±‡∏î‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞‡∏î‡πâ‡∏ß‡∏¢ AI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏•‡∏Å‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß</p>
        <button class="btn" onclick="showPage('student-login-page')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
        <button class="btn btn-secondary" onclick="showPage('teacher-login-page')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</button>
    </div>

    <div id="student-login-page" class="page hidden">
        <button class="btn-back" onclick="showPage('role-page')">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
        <input type="text" id="std-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
        <input type="number" id="std-id" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 5 ‡∏´‡∏•‡∏±‡∏Å">
        <select id="std-room">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>
            <script>
                const rooms = ["1/1","1/2","1/3","1/4","1/5","2/1","2/2","2/3","2/4","2/5","3/1","3/2","3/3","3/4","4/1","4/2","4/3","5/1","5/2","5/3","5/4","6/1","6/2","6/3"];
                rooms.forEach(r => document.write(`<option value="${r}">${r}</option>`));
            </script>
        </select>
        <button class="btn" onclick="loginStudent()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div id="ai-page" class="page hidden">
        <button class="btn-back" onclick="showPage('role-page')">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <div style="background:white; padding:15px; border-radius:20px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
            <div id="user-display" style="font-weight:600; font-size:14px; color:#2d6a4f;"></div>
            <div style="font-weight:bold; color:#1b4332; background:var(--accent); padding:5px 12px; border-radius:15px;">‚≠ê <span id="user-score">0</span></div>
        </div>

        <div class="upload-zone">
            <video id="webcam" autoplay playsinline muted class="hidden"></video>
            <img id="img-preview" class="hidden">
            <div id="placeholder" style="color:#aaa; text-align:center;">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡∏¢‡∏∞</div>
        </div>

        <div style="display:flex; gap:8px;">
            <button class="btn btn-secondary" style="flex:1; font-size:14px;" onclick="startCamera()">üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á</button>
            <button class="btn btn-secondary" style="flex:1; font-size:14px;" onclick="document.getElementById('file-input').click()">üìÅ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>
        </div>
        <input type="file" id="file-input" class="hidden" accept="image/*" onchange="previewFile(event)">

        <button class="btn" onclick="predict()" style="background:#77dd77;">üöÄ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡∏¢‡∏∞</button>
        <div id="loading" class="hidden" style="text-align:center; color:#77dd77; font-weight:bold; margin:10px 0;">‚åõ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</div>

        <div id="result-box" class="result-card hidden">
            <h2 id="res-label" style="margin:0; color:#1b4332;">---</h2>
            <div id="res-conf" style="color:#666; margin-bottom:15px;">‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à 0%</div>
            <button class="btn" onclick="saveRecord()" style="background:#2d6a4f; margin:0;">‚úÖ ‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
        </div>

        <h3 style="margin-top:25px; border-left:4px solid var(--primary); padding-left:10px;">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
        <div id="my-history" class="history-grid"></div>
    </div>

    <div id="teacher-login-page" class="page hidden">
        <button class="btn-back" onclick="showPage('role-page')">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <h2>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</h2>
        <input type="password" id="teacher-pass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô">
        <button class="btn btn-secondary" onclick="loginTeacher()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
    </div>

    <div id="teacher-dashboard" class="page hidden">
        <button class="btn-back" onclick="showPage('role-page')">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        <h2 style="color:#2d6a4f;">Eco Point üèÜ</h2>
        <input type="text" id="search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" oninput="renderLeaderboard()">
        <select id="filter-room" onchange="renderLeaderboard()">
            <option value="">-- ‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>
            <script>rooms.forEach(r => document.write(`<option value="${r}">‡∏´‡πâ‡∏≠‡∏á ${r}</option>`));</script>
        </select>
        <div id="leaderboard" style="margin-top:15px;"></div>
    </div>

    <div id="detail-page" class="page hidden">
        <button class="btn-back" onclick="showPage('teacher-dashboard')">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <h2 id="detail-name" style="color:#2d6a4f;"></h2>
        <div id="detail-history" class="history-grid"></div>
    </div>
</div>

<script>
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/UQwja1MPO/";
    let model, webcam, currentUserID, allUsers = {};

    // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡πÉ‡∏ä‡πâ Key ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î)
    function loadDB() {
        const saved = localStorage.getItem('ecosnap_v15_final');
        allUsers = saved ? JSON.parse(saved) : {};
    }
    loadDB();

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if(webcam && id !== 'ai-page') { webcam.stop(); webcam = null; }
    }

    // 2. ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    function loginStudent() {
        const name = document.getElementById('std-name').value.trim();
        const id = document.getElementById('std-id').value.trim();
        const room = document.getElementById('std-room').value;

        if(!name || id.length !== 5 || !room) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏à‡πâ‡∏≤");

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°
        if(!allUsers[id]) {
            allUsers[id] = { name, id, room, score: 0, history: [] };
        }
        currentUserID = id;
        saveDB();
        updateStudentUI();
        showPage('ai-page');
    }

    function updateStudentUI() {
        loadDB(); // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        const u = allUsers[currentUserID];
        document.getElementById('user-display').innerText = `${u.name} | ${u.room}`;
        document.getElementById('user-score').innerText = u.score;
        renderList('my-history', u.history);
    }

    async function startCamera() {
        document.getElementById('placeholder').classList.add('hidden');
        document.getElementById('img-preview').classList.add('hidden');
        const v = document.getElementById('webcam');
        v.classList.remove('hidden');
        if(!model) model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
        webcam = new tmImage.Webcam(300, 300, false);
        await webcam.setup({ facingMode: "environment" });
        await webcam.play();
        const loop = () => { if(webcam) { webcam.update(); requestAnimationFrame(loop); } };
        requestAnimationFrame(loop);
    }

    function previewFile(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
            const img = document.getElementById('img-preview');
            img.src = ev.target.result;
            img.classList.remove('hidden');
            document.getElementById('webcam').classList.add('hidden');
            document.getElementById('placeholder').classList.add('hidden');
            if(webcam) { webcam.stop(); webcam = null; }
        };
        reader.readAsDataURL(file);
    }

    async function predict() {
        if(!model) model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
        document.getElementById('loading').classList.remove('hidden');
        const source = document.getElementById('img-preview').classList.contains('hidden') ? webcam.canvas : document.getElementById('img-preview');
        const res = await model.predict(source);
        const top = res.sort((a,b) => b.probability - a.probability)[0];
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('result-box').classList.remove('hidden');
        document.getElementById('res-label').innerText = top.className;
        document.getElementById('res-conf').innerText = `‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à ${(top.probability * 100).toFixed(1)}%`;
    }

    // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏¢‡∏∞ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô)
    function saveRecord() {
        const label = document.getElementById('res-label').innerText;
        const conf = document.getElementById('res-conf').innerText;
        let img = "";

        const prev = document.getElementById('img-preview');
        if(!prev.classList.contains('hidden')) {
            img = prev.src;
        } else if(webcam) {
            img = webcam.canvas.toDataURL('image/jpeg', 0.5);
        }

        if(!img) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û");

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        allUsers[currentUserID].score += 1;
        allUsers[currentUserID].history.unshift({
            label, conf, img, time: new Date().toLocaleString('th-TH')
        });

        saveDB(); // ‡πÄ‡∏ã‡∏ü‡∏•‡∏á LocalStorage

        // **‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ**
        document.getElementById('result-box').classList.add('hidden');
        document.getElementById('img-preview').classList.add('hidden');
        document.getElementById('webcam').classList.add('hidden');
        document.getElementById('placeholder').classList.remove('hidden');
        if(webcam) { webcam.stop(); webcam = null; }

        // **‡∏ß‡∏≤‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•**
        updateStudentUI(); 
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! +1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô üåø");
    }

    function renderList(target, data) {
        const container = document.getElementById(target);
        if(!data || data.length === 0) {
            container.innerHTML = "<p style='grid-column:1/-1; text-align:center; opacity:0.5;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>";
            return;
        }
        container.innerHTML = data.map(h => `
            <div class="history-card">
                <img src="${h.img}">
                <div class="history-info">
                    <strong>${h.label}</strong><br>
                    ${h.conf}<br>
                    <small style="color:gray">${h.time}</small>
                </div>
            </div>
        `).join('');
    }

    function loginTeacher() {
        if(document.getElementById('teacher-pass').value === "Eco2026") {
            showPage('teacher-dashboard');
            renderLeaderboard();
        } else alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    }

    function renderLeaderboard() {
        loadDB();
        const search = document.getElementById('search-input').value.toLowerCase();
        const room = document.getElementById('filter-room').value;
        const container = document.getElementById('leaderboard');
        container.innerHTML = "";
        
        Object.values(allUsers)
            .filter(u => (u.name.toLowerCase().includes(search) || u.id.includes(search)) && (room === "" || u.room === room))
            .sort((a,b) => b.score - a.score)
            .forEach(u => {
                const div = document.createElement('div');
                div.className = "score-row";
                div.onclick = () => {
                    document.getElementById('detail-name').innerText = u.name;
                    renderList('detail-history', u.history);
                    showPage('detail-page');
                };
                div.innerHTML = `<div><strong>${u.name}</strong><br><small>${u.id} | ‡∏´‡πâ‡∏≠‡∏á ${u.room}</small></div><b style="color:#77dd77; font-size:20px;">${u.score}</b>`;
                container.appendChild(div);
            });
    }

    function saveDB() { localStorage.setItem('ecosnap_v15_final', JSON.stringify(allUsers)); }
</script>
</body>
</html>
