<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Eco Snap AI</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:sans-serif;
  background:#e8f5e9;
}
.page{display:none;min-height:100vh;padding:20px}
.active{display:block}
h1{text-align:center}
.card{
  background:#fff;
  padding:20px;
  border-radius:20px;
  margin-top:15px;
}
button,input,select{
  width:100%;
  padding:14px;
  margin-top:10px;
  border-radius:30px;
  border:1px solid #ccc;
  font-size:16px;
}
button{background:#2e7d32;color:#fff;border:none}
.score{
  position:fixed;
  top:10px;
  right:15px;
  background:#2e7d32;
  color:#fff;
  padding:6px 14px;
  border-radius:20px;
}
.image-box{
  height:220px;
  background:#eee;
  border-radius:15px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.image-box img{max-width:100%;max-height:100%;border-radius:10px}
.history{
  background:#f1f8e9;
  padding:10px;
  border-radius:10px;
  margin-top:10px;
}
.gold{color:gold;font-weight:bold}
</style>
</head>

<body>

<!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó -->
<div id="rolePage" class="page active">
  <h1>üå± Eco Snap AI</h1>
  <button onclick="show('studentLogin')">üë©‚Äçüéì ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
  <button onclick="show('teacherLogin')">üë©‚Äçüè´ ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</button>
</div>

<!-- ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô -->
<div id="studentLogin" class="page">
  <h1>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
  <input id="stuName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
  <input id="stuId" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
  <select id="stuRoom">
    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
    <option>1/1</option><option>1/2</option><option>1/3</option><option>1/4</option><option>1/5</option>
    <option>2/1</option><option>2/2</option><option>2/3</option><option>2/4</option><option>2/5</option>
    <option>3/1</option><option>3/2</option><option>3/3</option><option>3/4</option>
    <option>4/1</option><option>4/2</option><option>4/3</option>
    <option>5/1</option><option>5/2</option><option>5/3</option><option>5/4</option>
    <option>6/1</option><option>6/2</option><option>6/3</option>
  </select>
  <button onclick="studentLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
</div>

<!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô -->
<div id="studentPage" class="page">
  <div class="score">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô <span id="score">0</span></div>
  <h1>‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞‡∏î‡πâ‡∏ß‡∏¢ AI</h1>

  <div class="card">
    <div class="image-box">
      <span id="ph">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</span>
      <img id="preview" style="display:none">
    </div>
    <input type="file" accept="image/*" id="imgInput">
    <button onclick="analyze()">üß† ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
    <button onclick="save()">‚úÖ ‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à</button>
    <div id="result"></div>
  </div>

  <div class="card">
    <h3>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h3>
    <div id="history"></div>
  </div>
</div>

<!-- ‡∏Ñ‡∏£‡∏π‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô -->
<div id="teacherLogin" class="page">
  <h1>‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</h1>
  <input id="teacherPass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
  <button onclick="teacherLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
</div>

<!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏π -->
<div id="teacherPage" class="page">
  <h1>üèÜ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h1>
  <input id="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ / ‡∏£‡∏´‡∏±‡∏™" oninput="renderTeacher()">
  <select id="roomFilter" onchange="renderTeacher()">
    <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
    <option>1/1</option><option>1/2</option><option>1/3</option><option>1/4</option><option>1/5</option>
    <option>2/1</option><option>2/2</option><option>2/3</option><option>2/4</option><option>2/5</option>
    <option>3/1</option><option>3/2</option><option>3/3</option><option>3/4</option>
    <option>4/1</option><option>4/2</option><option>4/3</option>
    <option>5/1</option><option>5/2</option><option>5/3</option><option>5/4</option>
    <option>6/1</option><option>6/2</option><option>6/3</option>
  </select>
  <div id="board"></div>
</div>

<script>
 
let students = JSON.parse(localStorage.getItem("students") || "{}");
let student = null;

const URL = "https://teachablemachine.withgoogle.com/models/UQwja1MPO/";
let model;
let current = null;

function show(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

/* ===== ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ===== */
function studentLogin(){
  const id = sid.value;
  const name = sname.value;
  const room = sroom.value;

  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
  if(students[id]){
    student = students[id];
  }else{
    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
    student = {
      id: id,
      name: name,
      room: room,
      score: 0,
      history: []
    };
    students[id] = student;
    localStorage.setItem("students", JSON.stringify(students));
  }

  score.innerText = student.score;
  show('studentPage');
}
  
imgInput.onchange=()=>{
  const r=new FileReader();
  r.onload=()=>{
    preview.src=r.result;
    preview.style.display="block";
    ph.style.display="none";
  };
  r.readAsDataURL(imgInput.files[0]);
};

async function analyze(){
  if(!model){
    model=await tmImage.load(URL+"model.json",URL+"metadata.json");
  }
  const p=await model.predict(preview);
  p.sort((a,b)=>b.probability-a.probability);
  current=p[0];
  result.innerHTML=`${current.className} (${(current.probability*100).toFixed(2)}%)`;
}

function save(){
  if(!current) return alert("‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡πà‡∏≠‡∏ô");

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
  student.score += 1;
  score.innerText = student.score;

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
  student.history.push({
    type: current.className,
    time: new Date().toLocaleString()
  });

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏•‡∏±‡∏ö students
  students[student.id] = student;
  localStorage.setItem("students", JSON.stringify(students));

  // reset ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ä‡∏¥‡πâ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
  current = null;
  result.innerText = "";
  imgInput.value = "";
  preview.style.display = "none";
  ph.style.display = "block";
}

function renderHistory(){
  history.innerHTML="";
  const data=JSON.parse(localStorage.getItem("records")||"[]")
    .filter(d=>d.id===student.id);
  data.forEach(d=>{
    history.innerHTML+=`
    <div class="history">
      <img src="${d.img}" width="80"><br>
      ${d.type} (${d.conf}%)<br>${d.time}
    </div>`;
  });
}

function reset(){
  imgInput.value="";
  preview.style.display="none";
  ph.style.display="block";
  result.innerHTML="";
  current=null;
}

/* ===== ‡∏Ñ‡∏£‡∏π ===== */
function teacherLogin(){
  const password = document.getElementById("tpass").value;

  if(password !== "Eco2026"){
    alert("‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    return;
  }

  show('teacherPage');
}
function renderTeacher(){
  const q=search.value.toLowerCase();
  const room=roomFilter.value;
  let data=JSON.parse(localStorage.getItem("records")||"[]");

  if(q) data=data.filter(d=>d.name.includes(q)||d.id.includes(q));
  if(room) data=data.filter(d=>d.room===room);

  data.sort((a,b)=>b.score-a.score);

  board.innerHTML="";
  data.forEach((d,i)=>{
    board.innerHTML+=`
    <div class="${i<3?'gold':''}">
      ${i+1}. ${d.name} (${d.room}) - ${d.score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
    </div>`;
  });
}
</script>

</body>
</html>
