<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eco Snap AI</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #76ba99; --secondary: #adcf9f; --accent: #ffb7b2; --bg: #fdfdfd; }
        body { font-family: 'Kanit', sans-serif; background-color: var(--bg); margin: 0; display: flex; justify-content: center; overflow-x: hidden; }
        .mobile-app { width: 100vw; max-width: 450px; min-height: 100vh; background: white; position: relative; display: flex; flex-direction: column; }
        .page { padding: 20px; flex: 1; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        
        /* UI Components */
        .btn { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 20px; font-size: 18px; font-weight: 600; cursor: pointer; margin-top: 10px; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn:active { transform: scale(0.98); }
        .btn-secondary { background: var(--secondary); }
        .input-box { width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 15px; box-sizing: border-box; font-size: 16px; margin-top: 8px; outline: none; }
        .input-box:focus { border-color: var(--primary); }

        /* Header */
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .score-card { background: var(--accent); padding: 8px 15px; border-radius: 15px; font-weight: bold; color: white; }
        
        /* Analyze Area */
        .upload-area { width: 100%; aspect-ratio: 1/1; border: 3px dashed #ddd; border-radius: 30px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #fafafa; position: relative; overflow: hidden; }
        #preview-img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Analysis Result */
        .result-box { border: 4px solid var(--primary); border-radius: 25px; padding: 20px; margin-top: 20px; text-align: center; background: #f0fff4; animation: pop 0.3s ease-out; }
        @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* History */
        .history-section { margin-top: 30px; }
        .history-card { display: flex; align-items: center; padding: 12px; background: #fff; border-radius: 20px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #f0f0f0; }
        .history-card img { width: 55px; height: 55px; border-radius: 12px; object-fit: cover; margin-right: 15px; }

        /* Teacher Table */
        .teacher-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .teacher-table th { text-align: left; padding: 10px; color: #888; border-bottom: 2px solid #eee; }
        .teacher-table td { padding: 15px 10px; border-bottom: 1px solid #f9f9f9; }
    </style>
</head>
<body>

<div class="mobile-app">
    <div id="page-role" class="page">
        <h1 style="text-align:center; color: var(--primary); margin-top: 100px; font-size: 32px;">Eco Snap AI üçÉ</h1>
        <p style="text-align:center; color: #666;">‡∏ä‡πà‡∏ß‡∏¢‡πÇ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞</p>
        <div style="margin-top: 50px; display: flex; flex-direction: column; gap: 15px;">
            <button class="btn" onclick="goTo('page-student-login')">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <button class="btn btn-secondary" onclick="goTo('page-teacher-verify')">‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="page-student-login" class="page hidden">
        <div class="app-header">
            <button onclick="goTo('page-role')" style="background:none; border:none; font-size: 24px;">‚Üê</button>
            <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
            <div style="width:24px;"></div>
        </div>
        <input type="text" id="reg-name" class="input-box" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
        <input type="number" id="reg-id" class="input-box" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 5 ‡∏´‡∏•‡∏±‡∏Å">
        <select id="reg-room" class="input-box">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
            <script>
                const rs = ["1/1","1/2","1/3","1/4","1/5","2/1","2/2","2/3","2/4","2/5","3/1","3/2","3/3","3/4","4/1","4/2","4/3","5/1","5/2","5/3","5/4","6/1","6/2","6/3"];
                rs.forEach(r => document.write(`<option value="${r}">${r}</option>`));
            </script>
        </select>
        <button id="btn-login-submit" class="btn" style="margin-top: 30px;" onclick="doStudentLogin()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏¢</button>
    </div>

    <div id="page-analyze" class="page hidden">
        <div class="app-header">
            <button onclick="goTo('page-role')" style="background:none; border:none; font-size: 24px;">üè†</button>
            <div id="user-display" style="font-size: 14px; text-align: center;"></div>
            <div class="score-card">‚≠ê <span id="score-val">0</span></div>
        </div>

        <div class="upload-area" onclick="document.getElementById('input-file').click()">
            <img id="preview-img" class="hidden">
            <div id="upload-hint">üì∏ ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏Ç‡∏¢‡∏∞</div>
        </div>
        <input type="file" id="input-file" accept="image/*" class="hidden" onchange="previewImage(event)">
        
        <button id="btn-run-ai" class="btn hidden" onclick="runAI()">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡∏¢‡∏∞</button>
        <div id="ai-loading" class="hidden" style="text-align:center; padding: 20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</div>

        <div id="result-area" class="result-box hidden">
            <p style="margin:0; font-size:14px; color:#666;">‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏∑‡∏≠</p>
            <h2 id="res-type" style="margin:5px 0; color:var(--primary);">...</h2>
            <p>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô <span id="res-conf">0</span>%</p>
            <button class="btn" style="width:100%" onclick="saveAndReset()">‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
        </div>

        <div class="history-section">
            <h4>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞</h4>
            <div id="history-list"></div>
        </div>
    </div>

    <div id="page-teacher-verify" class="page hidden">
        <button onclick="goTo('page-role')" style="border:none; background:none; font-size:24px;">‚Üê</button>
        <h2 style="text-align:center;">‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</h2>
        <input type="password" id="t-pass" class="input-box" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π">
        <button class="btn" onclick="doTeacherLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div id="page-teacher-dashboard" class="page hidden">
        <div class="app-header">
            <button onclick="goTo('page-role')" style="border:none; background:none; font-size:24px;">üè†</button>
            <h2 style="margin:0;">Eco Point</h2>
            <div style="width:24px;"></div>
        </div>
        
        <input type="text" id="t-search" class="input-box" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™..." oninput="renderTeacherTable()">
        <select id="t-room-filter" class="input-box" onchange="renderTeacherTable()">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
            <script>rs.forEach(r => document.write(`<option value="${r}">${r}</option>`));</script>
        </select>

        <table class="teacher-table">
            <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th></tr></thead>
            <tbody id="teacher-tbody"></tbody>
        </table>
    </div>
</div>

<script>
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/UQwja1MPO/";
    let model, currentUser = null, currentResult = null;

    // Load AI
    async function init() {
        model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
    }
    init();

    function goTo(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function previewImage(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = document.getElementById('preview-img');
                img.src = event.target.result;
                img.classList.remove('hidden');
                document.getElementById('upload-hint').classList.add('hidden');
                document.getElementById('btn-run-ai').classList.remove('hidden');
                document.getElementById('result-area').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }
    }

    async function runAI() {
        document.getElementById('btn-run-ai').classList.add('hidden');
        document.getElementById('ai-loading').classList.remove('hidden');
        
        const img = document.getElementById('preview-img');
        const predictions = await model.predict(img);
        
        let top = { probability: 0, className: "" };
        predictions.forEach(p => { if(p.probability > top.probability) top = p; });

        currentResult = {
            type: top.className,
            conf: (top.probability * 100).toFixed(1),
            time: new Date().toLocaleString('th-TH'),
            img: img.src
        };

        setTimeout(() => {
            document.getElementById('ai-loading').classList.add('hidden');
            document.getElementById('result-area').classList.remove('hidden');
            document.getElementById('res-type').innerText = currentResult.type;
            document.getElementById('res-conf').innerText = Math.floor(currentResult.conf);
        }, 800);
    }

    function doStudentLogin() {
        const name = document.getElementById('reg-name').value;
        const id = document.getElementById('reg-id').value;
        const room = document.getElementById('reg-room').value;
        
        if(!name || id.length !== 5 || !room) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");

        let db = JSON.parse(localStorage.getItem('eco_db') || '{}');
        if(!db[id]) db[id] = { name, room, score: 0, history: [] };
        
        currentUser = { ...db[id], id };
        localStorage.setItem('eco_db', JSON.stringify(db));
        
        syncStudentUI();
        goTo('page-analyze');
    }

    function syncStudentUI() {
        document.getElementById('score-val').innerText = currentUser.score;
        document.getElementById('user-display').innerHTML = `<b>${currentUser.name}</b><br>‡∏´‡πâ‡∏≠‡∏á ${currentUser.room}`;
        
        const list = document.getElementById('history-list');
        list.innerHTML = currentUser.history.map(h => `
            <div class="history-card">
                <img src="${h.img}">
                <div>
                    <strong>${h.type}</strong><br>
                    <small>${h.conf}% | ${h.time}</small>
                </div>
            </div>
        `).join('');
    }

    function saveAndReset() {
        let db = JSON.parse(localStorage.getItem('eco_db'));
        
        // 1. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
        db[currentUser.id].score += 1;
        db[currentUser.id].history.unshift(currentResult);
        
        // 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á LocalStorage
        localStorage.setItem('eco_db', JSON.stringify(db));
        
        // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        currentUser = { ...db[currentUser.id], id: currentUser.id };
        
        // 4. Reset ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        document.getElementById('preview-img').classList.add('hidden');
        document.getElementById('preview-img').src = "";
        document.getElementById('upload-hint').classList.remove('hidden');
        document.getElementById('result-area').classList.add('hidden');
        document.getElementById('input-file').value = "";
        currentResult = null;

        syncStudentUI(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    }

    function doTeacherLogin() {
        if(document.getElementById('t-pass').value === 'Eco2026') {
            renderTeacherTable();
            goTo('page-teacher-dashboard');
        } else alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    }

    function renderTeacherTable() {
        const db = JSON.parse(localStorage.getItem('eco_db') || '{}');
        const search = document.getElementById('t-search').value.toLowerCase();
        const roomF = document.getElementById('t-room-filter').value;
        
        const sorted = Object.keys(db).map(id => ({...db[id], id})).sort((a,b) => b.score - a.score);
        
        const tbody = document.getElementById('teacher-tbody');
        tbody.innerHTML = sorted
            .filter(u => (u.name.toLowerCase().includes(search) || u.id.includes(search)) && (roomF === "" || u.room === roomF))
            .map(u => `
                <tr onclick="viewHistoryAsTeacher('${u.id}')">
                    <td>${u.name}</td>
                    <td>${u.room}</td>
                    <td><b>${u.score}</b></td>
                </tr>
            `).join('');
    }

    function viewHistoryAsTeacher(id) {
        const db = JSON.parse(localStorage.getItem('eco_db'));
        currentUser = { ...db[id], id };
        syncStudentUI();
        goTo('page-analyze');
        // ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
        document.querySelector('.upload-area').classList.add('hidden');
    }
</script>
</body>
</html>
