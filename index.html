<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eco Snap AI</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #76ba99; --secondary: #adcf9f; --accent: #ffb7b2; --bg: #fdfdfd; }
        body { font-family: 'Kanit', sans-serif; background-color: var(--bg); margin: 0; display: flex; justify-content: center; }
        .app-container { width: 100vw; max-width: 450px; min-height: 100vh; background: white; box-shadow: 0 0 15px rgba(0,0,0,0.05); position: relative; }
        .page { padding: 20px; box-sizing: border-box; }
        .hidden { display: none !important; }
        
        /* Elements */
        .btn { width: 100%; padding: 15px; border-radius: 15px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        .btn-main { background: var(--primary); color: white; }
        .btn-teacher { background: #3498db; color: white; }
        .input-box { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 12px; margin-top: 8px; box-sizing: border-box; }

        /* Header */
        .header-ui { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .score-box { background: gold; padding: 5px 12px; border-radius: 10px; font-weight: bold; }

        /* AI Section */
        #camera-area { width: 100%; aspect-ratio: 1/1; border: 4px dashed var(--secondary); border-radius: 20px; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #fafafa; position: relative; }
        #preview-img { width: 100%; height: 100%; object-fit: cover; }
        
        .result-card { border: 3px solid var(--primary); padding: 15px; border-radius: 20px; margin-top: 15px; text-align: center; background: #f0fff4; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* History */
        .history-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .history-item img { width: 50px; height: 50px; border-radius: 8px; margin-right: 12px; object-fit: cover; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="page-role" class="page">
        <h1 style="text-align:center; color: var(--primary); margin-top: 50px;">Eco Snap AI</h1>
        <p style="text-align:center;">‡∏Ñ‡∏±‡∏î‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏°‡∏≠‡∏á‡∏Å‡∏•</p>
        <div style="margin-top: 40px;">
            <button class="btn btn-main" onclick="showPage('page-student-login')">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
            <button class="btn btn-teacher" onclick="showPage('page-teacher-verify')">‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</button>
        </div>
    </div>

    <div id="page-student-login" class="page hidden">
        <button onclick="showPage('page-role')" style="background:none; border:none; color:red;">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
        <input type="text" id="std-name" class="input-box" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
        <input type="number" id="std-id" class="input-box" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 5 ‡∏´‡∏•‡∏±‡∏Å">
        <select id="std-room" class="input-box">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
            <script>
                const rooms = ["1/1","1/2","1/3","1/4","1/5","2/1","2/2","2/3","2/4","2/5","3/1","3/2","3/3","3/4","4/1","4/2","4/3","5/1","5/2","5/3","5/4","6/1","6/2","6/3"];
                rooms.forEach(r => document.write(`<option value="${r}">${r}</option>`));
            </script>
        </select>
        <button class="btn btn-main" onclick="loginStudent()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div id="page-ai" class="page hidden">
        <div class="header-ui">
            <button onclick="showPage('page-role')" style="border:none; background:none; font-size:20px;">üè†</button>
            <div id="info-text" style="font-size: 13px;"></div>
            <div class="score-box">‚≠ê <span id="score-display">0</span></div>
        </div>

        <div id="camera-area" onclick="document.getElementById('file-input').click()">
            <img id="preview-img" class="hidden">
            <p id="placeholder-text">üì∏ ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û/‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</p>
        </div>
        <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFile(event)">
        
        <button id="btn-analyze" class="btn btn-main hidden" onclick="startPredicting()">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡∏¢‡∏∞</button>
        <div id="status-loading" class="hidden" style="text-align:center; padding:15px;">üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>

        <div id="result-box" class="result-card hidden">
            <p style="margin:0; font-size:12px; color:#666;">‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</p>
            <h2 id="res-label" style="margin:5px 0; color:var(--primary);">...</h2>
            <p id="res-conf" style="margin:0; font-size:14px;"></p>
            <button class="btn btn-main" onclick="finishAndSave()">‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
        </div>

        <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
        <h4>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h4>
        <div id="history-container"></div>
    </div>

    <div id="page-teacher-verify" class="page hidden">
        <button onclick="showPage('page-role')" style="border:none; background:none;">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <h2>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</h2>
        <input type="password" id="t-pass" class="input-box" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô">
        <button class="btn btn-teacher" onclick="teacherLogin()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
    </div>

    <div id="page-teacher-dashboard" class="page hidden">
        <div class="header-ui">
            <button onclick="showPage('page-role')" style="border:none; background:none;">üè†</button>
            <h2>Eco Point</h2>
            <div></div>
        </div>
        <input type="text" id="t-search" class="input-box" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™..." oninput="renderLeaderboard()">
        <select id="t-room" class="input-box" onchange="renderLeaderboard()">
            <option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
            <script>rooms.forEach(r => document.write(`<option value="${r}">${r}</option>`));</script>
        </select>
        <table style="width:100%; margin-top:15px; border-collapse: collapse;">
            <thead><tr style="text-align:left; border-bottom:2px solid #eee;"><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th></tr></thead>
            <tbody id="leaderboard-body"></tbody>
        </table>
    </div>
</div>

<script>
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/UQwja1MPO/";
    let model, currentUser = null, currentPrediction = null;

    async function loadModel() {
        model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
    }
    loadModel();

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    // Login
    function loginStudent() {
        const name = document.getElementById('std-name').value;
        const id = document.getElementById('std-id').value;
        const room = document.getElementById('std-room').value;
        
        if(!name || id.length !== 5 || !room) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");

        let users = JSON.parse(localStorage.getItem('eco_users') || '{}');
        if(!users[id]) users[id] = { name, room, score: 0, history: [] };
        
        currentUser = { ...users[id], id: id };
        updateStudentUI();
        showPage('page-ai');
    }

    function updateStudentUI() {
        document.getElementById('score-display').innerText = currentUser.score;
        document.getElementById('info-text').innerHTML = `<b>${currentUser.name}</b> (${currentUser.room})`;
        const container = document.getElementById('history-container');
        container.innerHTML = currentUser.history.map(h => `
            <div class="history-item">
                <img src="${h.img}">
                <div>
                    <strong>${h.label}</strong><br>
                    <small>${h.conf}% | ${h.time}</small>
                </div>
            </div>
        `).join('');
    }

    // AI & File
    function handleFile(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = document.getElementById('preview-img');
                img.src = event.target.result;
                img.classList.remove('hidden');
                document.getElementById('placeholder-text').classList.add('hidden');
                document.getElementById('btn-analyze').classList.remove('hidden');
                document.getElementById('result-box').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }
    }

    async function startPredicting() {
        document.getElementById('btn-analyze').classList.add('hidden');
        document.getElementById('status-loading').classList.remove('hidden');
        
        const imgElement = document.getElementById('preview-img');
        const predictions = await model.predict(imgElement);
        
        let best = predictions.reduce((prev, curr) => (curr.probability > prev.probability) ? curr : prev);
        
        currentPrediction = {
            label: best.className,
            conf: (best.probability * 100).toFixed(1),
            time: new Date().toLocaleString('th-TH'),
            img: imgElement.src
        };

        setTimeout(() => {
            document.getElementById('status-loading').classList.add('hidden');
            document.getElementById('result-box').classList.remove('hidden');
            document.getElementById('res-label').innerText = currentPrediction.label;
            document.getElementById('res-conf').innerText = `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: ${currentPrediction.conf}%`;
        }, 800);
    }

    function finishAndSave() {
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á localStorage ---
        let users = JSON.parse(localStorage.getItem('eco_users'));
        
        users[currentUser.id].score += 1; // ‡∏ö‡∏ß‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        users[currentUser.id].history.unshift(currentPrediction); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏ß‡πâ‡∏ö‡∏ô‡∏™‡∏∏‡∏î
        
        localStorage.setItem('eco_users', JSON.stringify(users)); // ‡πÄ‡∏ã‡∏ü‡∏ó‡∏±‡∏ö‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ currentUser ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        currentUser = { ...users[currentUser.id], id: currentUser.id };

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: Reset ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏ä‡∏¥‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà ---
        document.getElementById('preview-img').classList.add('hidden');
        document.getElementById('preview-img').src = "";
        document.getElementById('placeholder-text').classList.remove('hidden');
        document.getElementById('result-box').classList.add('hidden');
        document.getElementById('file-input').value = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
        
        updateStudentUI(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! +1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô");
    }

    // ‡∏Ñ‡∏£‡∏π
    function teacherLogin() {
        if(document.getElementById('t-pass').value === 'Eco2026') {
            renderLeaderboard();
            showPage('page-teacher-dashboard');
        } else alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    }

    function renderLeaderboard() {
        const users = JSON.parse(localStorage.getItem('eco_users') || '{}');
        const search = document.getElementById('t-search').value.toLowerCase();
        const roomF = document.getElementById('t-room').value;
        
        let list = Object.keys(users).map(id => ({...users[id], id})).sort((a,b) => b.score - a.score);
        
        const tbody = document.getElementById('leaderboard-body');
        tbody.innerHTML = list
            .filter(u => (u.name.toLowerCase().includes(search) || u.id.includes(search)) && (roomF === 'all' || u.room === roomF))
            .map(u => `
                <tr onclick="viewUserHistory('${u.id}')" style="cursor:pointer; border-bottom:1px solid #f9f9f9;">
                    <td style="padding:12px 5px;">${u.name}</td>
                    <td>${u.room}</td>
                    <td><b>${u.score}</b></td>
                </tr>
            `).join('');
    }

    function viewUserHistory(id) {
        const users = JSON.parse(localStorage.getItem('eco_users'));
        currentUser = { ...users[id], id: id };
        updateStudentUI();
        showPage('page-ai');
        // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏î‡∏π
        document.getElementById('camera-area').style.pointerEvents = 'none';
        document.getElementById('placeholder-text').innerText = "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ";
    }
</script>

</body>
</html>
