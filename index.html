<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco Snap AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f0fdf4; }
        .mobile-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background: white; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .hidden-section { display: none; }
        .glass-card { background: rgba(255, 255, 255, 0.9); border: 2px solid #22c55e; border-radius: 20px; }
        .history-card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 10px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
    </style>
</head>
<body>

<div class="mobile-container">
    
    <section id="role-section" class="p-6 flex flex-col items-center justify-center h-screen">
        <img src="https://cdn-icons-png.flaticon.com/512/3246/3246314.png" class="w-32 mb-6">
        <h1 class="text-3xl font-bold text-green-600 mb-8">Eco Snap AI</h1>
        <p class="mb-4 text-gray-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
        <button onclick="showLogin('student')" class="w-full bg-green-500 text-white py-4 rounded-2xl text-xl font-semibold mb-4 shadow-lg active:scale-95 transition">üë®‚Äçüéì ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
        <button onclick="showLogin('teacher')" class="w-full bg-blue-500 text-white py-4 rounded-2xl text-xl font-semibold shadow-lg active:scale-95 transition">üë©‚Äçüè´ ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</button>
    </section>

    <section id="student-login-section" class="hidden-section p-6">
        <button onclick="goBack('role-section')" class="text-gray-500 mb-4">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <h2 class="text-2xl font-bold mb-6">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
        <div class="space-y-4">
            <input type="text" id="std-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="w-full p-4 border rounded-xl outline-none focus:ring-2 focus:ring-green-400">
            <input type="number" id="std-id" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 5 ‡∏´‡∏•‡∏±‡∏Å" class="w-full p-4 border rounded-xl outline-none focus:ring-2 focus:ring-green-400">
            <select id="std-room" class="w-full p-4 border rounded-xl outline-none focus:ring-2 focus:ring-green-400">
                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                <script>
                    const rooms = ["1/1","1/2","1/3","1/4","1/5","2/1","2/2","2/3","2/4","2/5","3/1","3/2","3/3","3/4","4/1","4/2","4/3","5/1","5/2","5/3","5/4","6/1","6/2","6/3"];
                    rooms.forEach(r => document.write(`<option value="${r}">${r}</option>`));
                </script>
            </select>
            <button id="btn-std-login" disabled onclick="studentLogin()" class="w-full bg-gray-300 text-white py-4 rounded-2xl text-xl font-semibold transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </section>

    <section id="analysis-section" class="hidden-section flex flex-col h-screen">
        <div class="p-4 bg-green-500 text-white flex justify-between items-center shadow-md">
            <button onclick="goBack('role-section')" class="text-white text-sm bg-green-600 px-3 py-1 rounded-lg">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
            <span class="font-bold">Eco Snap AI</span>
            <div class="text-right">
                <div id="display-name" class="text-xs"></div>
                <div id="display-score" class="font-bold text-yellow-300">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0</div>
            </div>
        </div>

        <div class="p-6 flex-1 overflow-y-auto">
            <div class="border-4 border-dashed border-green-200 rounded-3xl p-4 flex flex-col items-center justify-center min-h-[300px] mb-6 relative">
                <video id="webcam" autoplay playsinline class="w-full rounded-2xl hidden"></video>
                <img id="preview-img" class="w-full rounded-2xl hidden mb-4">
                <div id="upload-placeholder" class="text-center text-gray-400">
                    <p>üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏Ç‡∏¢‡∏∞</p>
                </div>
                <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFileUpload(event)">
            </div>

            <div class="flex gap-2 mb-6">
                <button onclick="startCamera()" class="flex-1 bg-gray-100 py-3 rounded-xl">üì∑ ‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                <button onclick="document.getElementById('file-input').click()" class="flex-1 bg-gray-100 py-3 rounded-xl">üìÅ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>
            </div>

            <button id="btn-analyze" onclick="analyzeImage()" class="w-full bg-green-500 text-white py-4 rounded-2xl text-xl font-semibold shadow-lg hidden">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡∏¢‡∏∞</button>
            
            <div id="result-box" class="hidden-section glass-card p-4 mt-4 text-center border-4">
                <h3 class="text-lg font-bold text-gray-700">‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h3>
                <div id="res-label" class="text-2xl font-bold text-green-600">...</div>
                <div id="res-conf" class="text-sm text-gray-500">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: 0%</div>
                <button onclick="finishTask()" class="mt-4 w-full bg-orange-500 text-white py-3 rounded-xl font-bold">‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
            </div>

            <hr class="my-8">
            <h3 class="font-bold mb-4">üïí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡πÅ‡∏¢‡∏Å</h3>
            <div id="history-list"></div>
        </div>
    </section>

    <section id="teacher-login-section" class="hidden-section p-6">
        <button onclick="goBack('role-section')" class="text-gray-500 mb-4">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <h2 class="text-2xl font-bold mb-6">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</h2>
        <input type="password" id="teacher-pass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô" class="w-full p-4 border rounded-xl mb-4">
        <button onclick="teacherLogin()" class="w-full bg-blue-500 text-white py-4 rounded-2xl text-xl font-semibold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
    </section>

    <section id="teacher-dashboard" class="hidden-section flex flex-col h-screen">
        <div class="p-4 bg-blue-600 text-white flex justify-between items-center shadow-md">
            <button onclick="goBack('role-section')" class="text-white text-sm bg-blue-700 px-3 py-1 rounded-lg">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
            <span class="font-bold">Eco Points</span>
            <span>üë®‚Äçüè´ ‡∏Ñ‡∏£‡∏π</span>
        </div>

        <div class="p-4 flex-1 overflow-y-auto">
            <div class="flex gap-2 mb-4">
                <input type="text" id="search-input" oninput="filterScore()" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="flex-1 p-3 border rounded-xl">
                <select id="filter-room" onchange="filterScore()" class="p-3 border rounded-xl">
                    <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
                    <script>rooms.forEach(r => document.write(`<option value="${r}">${r}</option>`));</script>
                </select>
            </div>

            <table class="w-full text-left">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-2">‡∏ä‡∏∑‡πà‡∏≠</th>
                        <th class="p-2">‡∏´‡πâ‡∏≠‡∏á</th>
                        <th class="p-2 text-right">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                    </tr>
                </thead>
                <tbody id="score-table-body">
                    </tbody>
            </table>
        </div>
    </section>

</div>

<script>
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/UQwja1MPO/";
    let model, webcam, labelContainer, maxPredictions;
    let currentUser = null;
    let capturedImage = null;

    // ‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á (‡πÉ‡∏ä‡πâ LocalStorage)
    const DB = {
        getUsers: () => JSON.parse(localStorage.getItem('eco_users') || '[]'),
        saveUser: (user) => {
            let users = DB.getUsers();
            let idx = users.findIndex(u => u.id === user.id);
            if(idx > -1) users[idx] = user; else users.push(user);
            localStorage.setItem('eco_users', JSON.stringify(users));
        }
    };

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
    document.querySelectorAll('#std-name, #std-id, #std-room').forEach(el => {
        el.addEventListener('input', () => {
            const name = document.getElementById('std-name').value;
            const id = document.getElementById('std-id').value;
            const room = document.getElementById('std-room').value;
            const btn = document.getElementById('btn-std-login');
            if(name && id.length === 5 && room) {
                btn.disabled = false;
                btn.classList.replace('bg-gray-300', 'bg-green-500');
            } else {
                btn.disabled = true;
                btn.classList.replace('bg-green-500', 'bg-gray-300');
            }
        });
    });

    function showLogin(role) {
        document.getElementById('role-section').classList.add('hidden-section');
        document.getElementById(role + '-login-section').classList.remove('hidden-section');
    }

    function goBack(target) {
        document.querySelectorAll('section').forEach(s => s.classList.add('hidden-section'));
        document.getElementById(target).classList.remove('hidden-section');
        if(webcam) webcam.stop();
    }

    async function studentLogin() {
        const id = document.getElementById('std-id').value;
        const name = document.getElementById('std-name').value;
        const room = document.getElementById('std-room').value;
        
        let users = DB.getUsers();
        currentUser = users.find(u => u.id === id) || { id, name, room, score: 0, history: [] };
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏™‡∏°‡∏≠
        currentUser.name = name;
        currentUser.room = room;
        DB.saveUser(currentUser);

        document.getElementById('display-name').innerText = `${currentUser.name} (${currentUser.room})`;
        updateStudentUI();
        goBack('analysis-section');
        
        // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• AI
        if(!model) {
            model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
        }
    }

    function updateStudentUI() {
        document.getElementById('display-score').innerText = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${currentUser.score}`;
        const list = document.getElementById('history-list');
        list.innerHTML = currentUser.history.map(h => `
            <div class="history-card">
                <img src="${h.img}" class="w-16 h-16 object-cover rounded-lg">
                <div class="flex-1">
                    <div class="font-bold text-green-700">${h.type}</div>
                    <div class="text-[10px] text-gray-400">${h.time} | ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à ${h.conf}%</div>
                </div>
            </div>
        `).reverse().join('');
    }

    async function startCamera() {
        const video = document.getElementById('webcam');
        video.classList.remove('hidden');
        document.getElementById('preview-img').classList.add('hidden');
        document.getElementById('upload-placeholder').classList.add('hidden');
        
        webcam = new tmImage.Webcam(300, 300, false); // false = ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
        await webcam.setup({ facingMode: "environment" });
        await webcam.play();
        window.requestAnimationFrame(loop);
        document.getElementById('btn-analyze').classList.remove('hidden');
    }

    function loop() {
        if(webcam && webcam.canvas) {
            webcam.update();
            window.requestAnimationFrame(loop);
        }
    }

    function handleFileUpload(e) {
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = document.getElementById('preview-img');
            img.src = event.target.result;
            img.classList.remove('hidden');
            document.getElementById('webcam').classList.add('hidden');
            document.getElementById('upload-placeholder').classList.add('hidden');
            document.getElementById('btn-analyze').classList.remove('hidden');
            capturedImage = event.target.result;
            if(webcam) webcam.stop();
        }
        reader.readAsDataURL(e.target.files[0]);
    }

    async function analyzeImage() {
        document.getElementById('btn-analyze').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...";
        
        let canvas = document.createElement('canvas');
        canvas.width = 300; canvas.height = 300;
        let ctx = canvas.getContext('2d');

        if(!document.getElementById('webcam').classList.contains('hidden')) {
            ctx.drawImage(webcam.canvas, 0, 0);
            capturedImage = canvas.toDataURL('image/jpeg');
        } else {
            const imgEl = document.getElementById('preview-img');
            ctx.drawImage(imgEl, 0, 0, 300, 300);
        }

        const prediction = await model.predict(canvas);
        prediction.sort((a,b) => b.probability - a.probability);

        const result = prediction[0];
        document.getElementById('res-label').innerText = result.className;
        document.getElementById('res-conf').innerText = `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: ${(result.probability * 100).toFixed(1)}%`;
        
        document.getElementById('result-box').classList.remove('hidden-section');
        document.getElementById('btn-analyze').classList.add('hidden');
        document.getElementById('btn-analyze').innerText = "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡∏¢‡∏∞";
    }

    function finishTask() {
        // 1. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        currentUser.score += 1;
        
        // 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
        const now = new Date();
        currentUser.history.push({
            img: capturedImage,
            type: document.getElementById('res-label').innerText,
            conf: document.getElementById('res-conf').innerText.replace('‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: ',''),
            time: now.toLocaleDateString() + ' ' + now.toLocaleTimeString()
        });

        DB.saveUser(currentUser);
        
        // 3. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        Swal.fire({ icon: 'success', title: '+1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô!', text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', timer: 1500, showConfirmButton: false });
        
        document.getElementById('result-box').classList.add('hidden-section');
        document.getElementById('preview-img').classList.add('hidden');
        document.getElementById('webcam').classList.add('hidden');
        document.getElementById('upload-placeholder').classList.remove('hidden');
        document.getElementById('btn-analyze').classList.add('hidden');
        
        updateStudentUI();
        if(webcam) webcam.stop();
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π ---
    function teacherLogin() {
        const pass = document.getElementById('teacher-pass').value;
        if(pass === "Eco2026") {
            goBack('teacher-dashboard');
            renderTeacherTable();
        } else {
            Swal.fire('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');
        }
    }

    function renderTeacherTable() {
        let users = DB.getUsers();
        const search = document.getElementById('search-input').value.toLowerCase();
        const roomFilter = document.getElementById('filter-room').value;

        let filtered = users.filter(u => {
            const matchSearch = u.name.toLowerCase().includes(search) || u.id.includes(search);
            const matchRoom = roomFilter === "" || u.room === roomFilter;
            return matchSearch && matchRoom;
        });

        filtered.sort((a,b) => b.score - a.score);

        const tbody = document.getElementById('score-table-body');
        tbody.innerHTML = filtered.map(u => `
            <tr class="border-b active:bg-gray-50" onclick="viewStudentHistory('${u.id}')">
                <td class="p-3 text-blue-600 underline">${u.name}</td>
                <td class="p-3">${u.room}</td>
                <td class="p-3 text-right font-bold text-green-600">${u.score}</td>
            </tr>
        `).join('');
    }

    function filterScore() { renderTeacherTable(); }

    function viewStudentHistory(id) {
        const user = DB.getUsers().find(u => u.id === id);
        let historyHtml = user.history.length > 0 ? user.history.map(h => `
            <div class="flex items-center gap-2 mb-2 p-2 border rounded">
                <img src="${h.img}" class="w-12 h-12 rounded object-cover">
                <div class="text-left text-xs">
                    <b>${h.type}</b><br>${h.time}
                </div>
            </div>
        `).join('') : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥";

        Swal.fire({
            title: `‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á ${user.name}`,
            html: `<div class="max-h-64 overflow-y-auto">${historyHtml}</div>`,
            confirmButtonText: '‡∏õ‡∏¥‡∏î'
        });
    }
</script>

</body>
</html>
