<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco Snap AI</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    
    <style>
        :root {
            --primary: #2ecc71;
            --secondary: #27ae60;
            --bg: #f4f7f6;
            --text: #2c3e50;
        }

        body {
            font-family: 'Kanit', sans-serif;
            margin: 0;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
        }

        #app {
            width: 100%;
            max-width: 480px; /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ö‡∏ô‡∏à‡∏≠‡∏Ñ‡∏≠‡∏° */
            min-height: 100vh;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
            padding: 20px;
            box-sizing: border-box;
        }

        .hidden { display: none !important; }

        /* ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞ Input */
        input, select, button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 10px;
            border: 1px solid #ddd;
            font-size: 16px;
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }

        button:disabled { background: #ccc; }

        .back-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            width: auto;
            padding: 5px 15px;
            background: #e74c3c;
        }

        /* ‡∏´‡∏ô‡πâ‡∏≤‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡∏¢‡∏∞ */
        #camera-container {
            width: 100%;
            height: 300px;
            border: 4px dashed var(--primary);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #webcam-view { width: 100%; height: 100%; object-fit: cover; }

        .result-box {
            border: 3px solid var(--primary);
            padding: 15px;
            border-radius: 15px;
            margin-top: 20px;
            background: #eafff2;
            text-align: center;
        }

        /* ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ */
        .history-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #eee;
            margin-bottom: 10px;
            border-radius: 10px;
        }
        .history-item img { width: 60px; height: 60px; border-radius: 5px; margin-right: 15px; }

        /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
    </style>
</head>
<body>

<div id="app">
    <div id="role-page" class="page">
        <h1 style="text-align: center;">Eco Snap AI</h1>
        <p style="text-align: center;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
        <button onclick="showPage('student-login-page')">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
        <button onclick="showPage('teacher-login-page')" style="background: #3498db;">‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</button>
    </div>

    <div id="student-login-page" class="page hidden">
        <button class="back-btn" onclick="showPage('role-page')">‡∏Å‡∏•‡∏±‡∏ö</button>
        <h2 style="margin-top: 50px;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
        <input type="text" id="std-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" oninput="validateLogin()">
        <input type="number" id="std-id" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 5 ‡∏´‡∏•‡∏±‡∏Å" maxlength="5" oninput="validateLogin()">
        <select id="std-room" onchange="validateLogin()">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
            <script>
                const rooms = ["1/1","1/2","1/3","1/4","1/5","2/1","2/2","2/3","2/4","2/5","3/1","3/2","3/3","3/4","4/1","4/2","4/3","5/1","5/2","5/3","5/4","6/1","6/2","6/3"];
                rooms.forEach(r => document.write(`<option value="${r}">${r}</option>`));
            </script>
        </select>
        <button id="login-btn" disabled onclick="loginStudent()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div id="ai-page" class="page hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <p id="display-user-info"></p>
            <div style="background: gold; padding: 5px 10px; border-radius: 10px;">
                Score: <span id="user-score">0</span>
            </div>
        </div>
        <h2 style="text-align:center;">Eco Snap AI</h2>
        
        <div id="camera-container">
            <video id="webcam-view" autoplay playsinline muted></video>
        </div>

        <button onclick="analyzeWaste()" id="analyze-btn">üì∏ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡∏¢‡∏∞</button>
        
        <div id="loading" class="hidden" style="text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</div>
        
        <div id="result-area" class="result-box hidden">
            <h3>‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h3>
            <p id="res-label" style="font-size: 20px; font-weight: bold;"></p>
            <p id="res-conf"></p>
            <button onclick="finishTask()" style="background: #27ae60;">‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
        </div>

        <hr>
        <h4>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞</h4>
        <div id="history-list"></div>
    </div>

    <div id="teacher-login-page" class="page hidden">
        <button class="back-btn" onclick="showPage('role-page')">‡∏Å‡∏•‡∏±‡∏ö</button>
        <h2 style="margin-top: 50px;">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</h2>
        <input type="password" id="teacher-pass" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô">
        <button onclick="loginTeacher()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™</button>
    </div>

    <div id="teacher-dashboard" class="page hidden">
        <button class="back-btn" onclick="showPage('role-page')">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        <h2 style="margin-top: 50px; text-align: center;">Eco Point</h2>
        
        <input type="text" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" oninput="renderLeaderboard()">
        <select id="filter-room" onchange="renderLeaderboard()">
            <option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
            <script>rooms.forEach(r => document.write(`<option value="${r}">${r}</option>`));</script>
        </select>

        <table>
            <thead>
                <tr>
                    <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                    <th>‡∏´‡πâ‡∏≠‡∏á</th>
                    <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body"></tbody>
        </table>
    </div>
</div>

<script>
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/UQwja1MPO/";
    let model, webcam, currentUser, label, confidence;

    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
        document.getElementById(pageId).classList.remove('hidden');
        if(pageId === 'ai-page') initWebcam();
    }

    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ---
    function validateLogin() {
        const name = document.getElementById('std-name').value;
        const id = document.getElementById('std-id').value;
        const room = document.getElementById('std-room').value;
        document.getElementById('login-btn').disabled = !(name && id.length === 5 && room);
    }

    function loginStudent() {
        const id = document.getElementById('std-id').value;
        const name = document.getElementById('std-name').value;
        const room = document.getElementById('std-room').value;
        
        let users = JSON.parse(localStorage.getItem('eco_users') || '{}');
        if(!users[id]) {
            users[id] = { name, room, score: 0, history: [] };
        }
        currentUser = { ...users[id], id: id };
        localStorage.setItem('eco_users', JSON.stringify(users));
        
        updateUI();
        showPage('ai-page');
    }

    function updateUI() {
        document.getElementById('display-user-info').innerText = `${currentUser.name} (${currentUser.room})`;
        document.getElementById('user-score').innerText = currentUser.score;
        renderHistory();
    }

    // --- ‡∏£‡∏∞‡∏ö‡∏ö AI (Teachable Machine) ---
    async function initWebcam() {
        if (!model) {
            model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
        }
        const flip = true;
        webcam = new tmImage.Webcam(300, 300, flip);
        await webcam.setup();
        await webcam.play();
        document.getElementById("webcam-view").srcObject = webcam.canvas.captureStream();
        window.requestAnimationFrame(loop);
    }

    async function loop() {
        webcam.update();
        window.requestAnimationFrame(loop);
    }

    async function analyzeWaste() {
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('result-area').classList.add('hidden');
        
        const prediction = await model.predict(webcam.canvas);
        // ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
        let maxPred = prediction.reduce((prev, current) => (prev.probability > current.probability) ? prev : current);
        
        label = maxPred.className;
        confidence = (maxPred.probability * 100).toFixed(2);

        setTimeout(() => {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('result-area').classList.remove('hidden');
            document.getElementById('res-label').innerText = label;
            document.getElementById('res-conf').innerText = `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: ${confidence}%`;
        }, 1000); // ‡∏î‡∏µ‡πÄ‡∏•‡∏¢‡πå‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î
    }

    function finishTask() {
        const now = new Date();
        const dateTime = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
        const item = {
            label,
            confidence,
            time: dateTime,
            img: webcam.canvas.toDataURL()
        };

        let users = JSON.parse(localStorage.getItem('eco_users'));
        users[currentUser.id].score += 1;
        users[currentUser.id].history.unshift(item);
        
        localStorage.setItem('eco_users', JSON.stringify(users));
        currentUser = { ...users[currentUser.id], id: currentUser.id };

        // Reset UI
        document.getElementById('result-area').classList.add('hidden');
        updateUI();
    }

    function renderHistory() {
        const container = document.getElementById('history-list');
        container.innerHTML = currentUser.history.map(h => `
            <div class="history-item">
                <img src="${h.img}">
                <div>
                    <strong>${h.label}</strong> (${h.confidence}%)<br>
                    <small>${h.time}</small>
                </div>
            </div>
        `).join('');
    }

    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π ---
    function loginTeacher() {
        if(document.getElementById('teacher-pass').value === 'Eco2026') {
            showPage('teacher-dashboard');
            renderLeaderboard();
        } else {
            alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!');
        }
    }

    function renderLeaderboard() {
        const users = JSON.parse(localStorage.getItem('eco_users') || '{}');
        const search = document.getElementById('search-input').value.toLowerCase();
        const filterRoom = document.getElementById('filter-room').value;
        
        let list = Object.keys(users).map(id => ({...users[id], id}));
        
        // Filter
        list = list.filter(u => {
            const matchSearch = u.name.toLowerCase().includes(search) || u.id.includes(search);
            const matchRoom = filterRoom === 'all' || u.room === filterRoom;
            return matchSearch && matchRoom;
        });

        // Sort ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏°‡∏≤‡∏Å -> ‡∏ô‡πâ‡∏≠‡∏¢
        list.sort((a, b) => b.score - a.score);

        const tbody = document.getElementById('leaderboard-body');
        tbody.innerHTML = list.map(u => `
            <tr onclick="viewUserDetail('${u.id}')" style="cursor:pointer;">
                <td>${u.name}</td>
                <td>${u.room}</td>
                <td>${u.score}</td>
            </tr>
        `).join('');
    }

    function viewUserDetail(id) {
        const users = JSON.parse(localStorage.getItem('eco_users'));
        const u = users[id];
        let historyHtml = u.history.map(h => `[${h.time}] ${h.label} (${h.confidence}%)`).join('\n');
        alert(`‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á ${u.name}:\n\n${historyHtml || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥'}`);
    }
</script>

</body>
</html>
