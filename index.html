<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Eco Snap AI</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest"></script>

<style>
body{margin:0;font-family:sans-serif;background:#e9f7ef}
header{background:#198754;color:#fff;padding:10px;display:flex;align-items:center}
.back{font-size:14px;margin-right:10px;cursor:pointer}
.container{padding:15px}
.hidden{display:none}
button{width:100%;padding:12px;border:none;border-radius:10px;background:#198754;color:#fff;font-size:16px;margin-top:10px}
.card{background:#fff;border-radius:12px;padding:12px;margin-top:10px}
img{max-width:100%;border-radius:10px}
input,select{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ccc}
.history{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px}
.score{margin-left:auto;font-weight:bold}
.small-btn{background:#0d6efd;font-size:14px}
</style>
</head>

<body>

<header>
  <span class="back hidden" onclick="goHome()">⬅</span>
  <span id="appTitle">Eco Snap AI</span>
  <span class="score" id="score"></span>
</header>

<div class="container">

<!-- ROLE -->
<div id="role">
  <button onclick="chooseRole('student')">นักเรียน</button>
  <button onclick="chooseRole('teacher')">ครู</button>
</div>

<!-- STUDENT LOGIN -->
<div id="studentLogin" class="hidden">
  <input id="sname" placeholder="ชื่อ-นามสกุล">
  <input id="sid" placeholder="รหัสนักเรียน">
  <select id="sclass">
    <option>ม.1/1</option><option>ม.1/2</option><option>ม.1/3</option><option>ม.1/4</option><option>ม.1/5</option>
    <option>ม.2/1</option><option>ม.2/2</option><option>ม.2/3</option><option>ม.2/4</option><option>ม.2/5</option>
    <option>ม.3/1</option><option>ม.3/2</option><option>ม.3/3</option><option>ม.3/4</option>
    <option>ม.4/1</option><option>ม.4/2</option><option>ม.4/3</option>
    <option>ม.5/1</option><option>ม.5/2</option><option>ม.5/3</option><option>ม.5/4</option>
    <option>ม.6/1</option><option>ม.6/2</option><option>ม.6/3</option>
  </select>
  <button onclick="loginStudent()">เข้าสู่ระบบ</button>
</div>

<!-- STUDENT APP -->
<div id="studentApp" class="hidden">
  <input type="file" id="imgInput" accept="image/*">
  <img id="preview">
  <button onclick="analyze()">วิเคราะห์</button>
  <div id="result" class="card hidden"></div>
  <button onclick="saveTrash()">แยกขยะเสร็จแล้ว</button>
  <h3>ประวัติ</h3>
  <div id="history" class="history"></div>
</div>

<!-- TEACHER -->
<div id="teacherLogin" class="hidden">
  <input id="tpass" placeholder="รหัสครู">
  <button onclick="loginTeacher()">เข้าสู่ระบบครู</button>
</div>

<div id="teacherApp" class="hidden">
  <select id="classFilter">
    <option value="">ทุกห้อง</option>
    <option>ม.1/1</option><option>ม.1/2</option><option>ม.1/3</option><option>ม.1/4</option><option>ม.1/5</option>
    <option>ม.2/1</option><option>ม.2/2</option><option>ม.2/3</option><option>ม.2/4</option><option>ม.2/5</option>
    <option>ม.3/1</option><option>ม.3/2</option><option>ม.3/3</option><option>ม.3/4</option>
    <option>ม.4/1</option><option>ม.4/2</option><option>ม.4/3</option>
    <option>ม.5/1</option><option>ม.5/2</option><option>ม.5/3</option><option>ม.5/4</option>
    <option>ม.6/1</option><option>ม.6/2</option><option>ม.6/3</option>
  </select>

  <input id="search" placeholder="ค้นหาชื่อหรือรหัส">
  <button class="small-btn" onclick="renderBoard()">ค้นหา</button>
  <div id="board"></div>
</div>

</div>

<script>
const MODEL_URL="https://teachablemachine.withgoogle.com/models/UQwja1MPO/";
let model,user,prediction;
const preview = document.getElementById("preview");
const imgInput = document.getElementById("imgInput");

const title = document.getElementById("appTitle");
const scoreBox=document.getElementById("score");
const result = document.getElementById("result");
imgInput.addEventListener("change", () => {
  const file = imgInput.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    preview.src = reader.result;
  };
  reader.readAsDataURL(file);
});
  
function goHome(){location.reload()}

function chooseRole(r){
  document.getElementById("role").classList.add("hidden");
  document.querySelector(".back").classList.remove("hidden");
  if(r==="student")studentLogin.classList.remove("hidden");
  else teacherLogin.classList.remove("hidden");
}

function loginStudent(){
  if(!sname.value || !sid.value || !sclass.value){
    alert("กรุณากรอกข้อมูลให้ครบก่อนเข้าสู่ระบบ");
    return;
  }

  let users = JSON.parse(localStorage.getItem("users")) || {};

  if(!users[sid.value]){
    users[sid.value] = {
      name: sname.value,
      class: sclass.value,
      score: 0,
      history: []
    };
  }

  user = users[sid.value];
  localStorage.setItem("current", sid.value);
  localStorage.setItem("users", JSON.stringify(users));

  studentLogin.classList.add("hidden");
  studentApp.classList.remove("hidden");

  title.innerText = `${user.name} (${user.class})`;
  updateScore();
  renderHistory();
}
async function analyze(){
  if(!imgInput.files.length){
    alert("กรุณาเลือกรูปก่อนวิเคราะห์");
    return;
  }

  if (!preview.src) {
    alert("รูปยังไม่พร้อม กรุณารอสักครู่");
    return;
  }

  result.classList.remove("hidden");
  result.innerText = "⏳ กำลังวิเคราะห์...";

  if (!model) {
  model = await tmImage.load(
    MODEL_URL + "model.json",
    MODEL_URL + "metadata.json"
  );
}

prediction = await model.predict(preview);

// หาค่าที่มั่นใจที่สุด
let best = prediction[0];
for (let i = 1; i < prediction.length; i++) {
  if (prediction[i].probability > best.probability) {
    best = prediction[i];
  }
}

// แสดงผล (สำคัญ: ใช้ backtick)
result.innerHTML = `
  <h3>ผลการวิเคราะห์</h3>
  <p>ประเภท: <b>${best.className}</b></p>
  <p>ความมั่นใจ: ${(best.probability * 100).toFixed(2)}%</p>
`;
  }

  // รอให้รูปโหลดจริง (แก้ iOS bug)
  await new Promise(resolve => {
    if (preview.complete) resolve();
    else preview.onload = resolve;
  });

  console.log("เริ่ม predict แล้ว", preview.src);
  const predictions = await model.predict(preview);
  prediction = predictions.sort(
    (a,b)=>b.probability - a.probability
  )[0];

  result.innerHTML = `
    <b>ผลการวิเคราะห์</b><br>
    ประเภทขยะ: <b>${prediction.className}</b><br>
    ความมั่นใจ: ${(prediction.probability*100).toFixed(2)}%
  `;
}

function saveTrash(){
  if(!prediction)return;
  let users=JSON.parse(localStorage.getItem("users"));
  user.history.unshift({
    img:preview.src,
    type:prediction.className,
    conf:prediction.probability,
    time:new Date().toLocaleString()
  });
  user.score++;
  users[localStorage.getItem("current")]=user;
  localStorage.setItem("users",JSON.stringify(users));
  imgInput.value=""; preview.src=""; result.classList.add("hidden");
  updateScore(); renderHistory();
}

function renderHistory(){
  history.innerHTML="";
  user.history.forEach(h=>{
    history.innerHTML+=`<div class="card"><img src="${h.img}"><b>${h.type}</b><br>${h.time}</div>`;
  });
}

function updateScore(){scoreBox.innerText=`⭐ ${user.score}`}

imgInput.onchange = e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    preview.src = reader.result;
    preview.onload = () => {
      console.log("✅ รูปโหลดเสร็จแล้ว");
    };
  };
  reader.readAsDataURL(file);
};

function loginTeacher(){
  if(tpass.value!=="Eco2026"){alert("รหัสผิด");return;}
  teacherLogin.classList.add("hidden");
  teacherApp.classList.remove("hidden");
  renderBoard();
}

function renderBoard(){
  const q=search.value.toLowerCase();
  const room=classFilter.value;
  const users=Object.values(JSON.parse(localStorage.getItem("users"))||{})
    .filter(u=>(!room||u.class===room)&&(!q||u.name.toLowerCase().includes(q)))
    .sort((a,b)=>b.score-a.score);

  board.innerHTML="";
  users.forEach(u=>{
    board.innerHTML+=`<div class="card"><b>${u.name}</b> (${u.class}) ⭐${u.score}</div>`;
  });
}
</script>

</body>
</html>
