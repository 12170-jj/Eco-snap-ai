<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco Snap AI - ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏Ñ‡∏±‡∏î‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #7ED957;
            --secondary-color: #FFDE59;
            --bg-color: #F0FDF4;
            --text-color: #2D3436;
        }

        body {
            font-family: 'Mitr', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            justify-content: center;
            color: var(--text-color);
        }

        .mobile-container {
            width: 100%;
            max-width: 450px;
            min-height: 100vh;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            padding: 20px;
            box-sizing: border-box;
            position: relative;
        }

        /* UI Elements */
        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
            font-family: 'Mitr';
        }

        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: #5D4037; }
        .btn-back { width: auto; font-size: 12px; padding: 5px 15px; position: absolute; top: 10px; left: 10px; }

        input, select {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #E2E8F0;
            border-radius: 12px;
            box-sizing: border-box;
        }

        .card {
            border: 2px dashed var(--primary-color);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
        }

        .result-box {
            border: 3px solid var(--primary-color);
            background: #f0fff4;
            padding: 15px;
            border-radius: 15px;
            margin-top: 15px;
            display: none;
        }

        .history-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }

        .history-img {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            margin-right: 10px;
            object-fit: cover;
        }

        #webcam-container video {
            width: 100%;
            border-radius: 15px;
            transform: scaleX(1); /* ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á Mirror */
        }

        .hidden { display: none; }
        
        /* Teacher Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
    </style>
</head>
<body>

<div class="mobile-container">
    <div id="page-role" class="page">
        <h1 style="text-align:center; color: var(--primary-color);">Eco Snap AI üåø</h1>
        <p style="text-align:center;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
        <button class="btn btn-primary" onclick="showPage('page-student-login')">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
        <button class="btn btn-secondary" onclick="showPage('page-teacher-auth')">‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</button>
    </div>

    <div id="page-student-login" class="page hidden">
        <button class="btn btn-back" onclick="showPage('page-role')">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <h2 style="text-align:center; margin-top: 40px;">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
        <input type="text" id="std-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
        <input type="number" id="std-id" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß 5 ‡∏´‡∏•‡∏±‡∏Å" oninput="validateLogin()">
        <select id="std-room" onchange="validateLogin()">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
            <script>
                const rooms = ['1/1','1/2','1/3','1/4','1/5','2/1','2/2','2/3','2/4','2/5','3/1','3/2','3/3','3/4','4/1','4/2','4/3','5/1','5/2','5/3','5/4','6/1','6/2','6/3'];
                rooms.forEach(r => document.write(`<option value="${r}">${r}</option>`));
            </script>
        </select>
        <button id="btn-login" class="btn btn-primary" disabled onclick="loginStudent()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div id="page-analysis" class="page hidden">
        <button class="btn btn-back" onclick="showPage('page-role')">‚¨Ö ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        <div style="text-align:right; margin-bottom: 10px;">
            <span id="display-name" style="font-weight:bold;"></span> <br>
            <small id="display-room"></small> | üèÜ <span id="display-score" style="color:green; font-weight:bold;">0</span> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        </div>
        <h2 style="text-align:center; color: var(--primary-color);">Eco Snap AI</h2>
        
        <div class="card">
            <div id="webcam-container"></div>
            <img id="image-preview" class="hidden" style="width:100%; border-radius:15px;">
            <p id="status-text">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</p>
        </div>

        <button class="btn btn-primary" onclick="startCamera()">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
        <input type="file" id="upload-img" accept="image/*" class="hidden" onchange="handleUpload(this)">
        <button class="btn btn-secondary" onclick="document.getElementById('upload-img').click()">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
        
        <button id="btn-analyze" class="btn btn-primary hidden" onclick="predict()">üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>

        <div id="result-area" class="result-box">
            <h3 style="margin:0;">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h3>
            <p id="predict-result" style="font-size:20px; font-weight:bold; color:var(--primary-color);"></p>
            <p id="predict-conf"></p>
            <button class="btn btn-primary" onclick="finishSort()">‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
        </div>

        <hr>
        <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞</h3>
        <div id="student-history"></div>
    </div>

    <div id="page-teacher-auth" class="page hidden">
        <button class="btn btn-back" onclick="showPage('page-role')">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <h2 style="text-align:center; margin-top: 40px;">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</h2>
        <input type="password" id="teacher-pw" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô">
        <button class="btn btn-primary" onclick="authTeacher()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
    </div>

    <div id="page-teacher-dashboard" class="page hidden">
        <button class="btn btn-back" onclick="showPage('page-role')">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <h2 style="text-align:center; margin-top: 40px;">Eco Points üèÜ</h2>
        
        <input type="text" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™..." onkeyup="filterTable()">
        <select id="filter-room" onchange="filterTable()">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
            </select>

        <table id="score-table">
            <thead>
                <tr>
                    <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                    <th>‡∏´‡πâ‡∏≠‡∏á</th>
                    <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                </tr>
            </thead>
            <tbody id="score-body"></tbody>
        </table>
    </div>

    <div id="page-view-history" class="page hidden">
        <button class="btn btn-back" onclick="showPage('page-teacher-dashboard')">‚¨Ö ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <h2 id="view-student-name" style="text-align:center; margin-top:40px;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
        <div id="history-detail-list"></div>
    </div>
</div>

<script>
    const URL = "https://teachablemachine.withgoogle.com/models/UQwja1MPO/";
    let model, webcam, labelContainer, maxPredictions;
    let currentUser = null;
    let currentPrediction = null;
    let currentImageBase64 = null;

    // --- Navigation ---
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
        document.getElementById(pageId).classList.remove('hidden');
        if(pageId === 'page-teacher-dashboard') renderScoreTable();
    }

    // --- Student Logic ---
    function validateLogin() {
        const name = document.getElementById('std-name').value;
        const id = document.getElementById('std-id').value;
        const room = document.getElementById('std-room').value;
        document.getElementById('btn-login').disabled = !(name && id.length === 5 && room);
    }

    function loginStudent() {
        const id = document.getElementById('std-id').value;
        const name = document.getElementById('std-name').value;
        const room = document.getElementById('std-room').value;
        
        let users = JSON.parse(localStorage.getItem('eco_users') || '{}');
        if (!users[id]) {
            users[id] = { id, name, room, score: 0, history: [] };
        } else {
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠/‡∏´‡πâ‡∏≠‡∏á ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡πÅ‡∏ï‡πà‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà
            users[id].name = name;
            users[id].room = room;
        }
        localStorage.setItem('eco_users', JSON.stringify(users));
        currentUser = users[id];
        
        updateStudentUI();
        showPage('page-analysis');
        initAI();
    }

    function updateStudentUI() {
        document.getElementById('display-name').innerText = currentUser.name;
        document.getElementById('display-room').innerText = "‡∏´‡πâ‡∏≠‡∏á " + currentUser.room;
        document.getElementById('display-score').innerText = currentUser.score;
        renderHistory();
    }

    // --- AI & Camera ---
    async function initAI() {
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";
        model = await tmImage.load(modelURL, metadataURL);
    }

    async function startCamera() {
        document.getElementById('status-text').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...";
        const flip = false; 
        webcam = new tmImage.Webcam(300, 300, flip);
        await webcam.setup({ facingMode: "environment" }); // ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á
        await webcam.play();
        document.getElementById('webcam-container').innerHTML = "";
        document.getElementById('webcam-container').appendChild(webcam.canvas);
        document.getElementById('image-preview').classList.add('hidden');
        document.getElementById('btn-analyze').classList.remove('hidden');
        document.getElementById('status-text').innerText = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå";
    }

    function handleUpload(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                currentImageBase64 = e.target.result;
                const img = document.getElementById('image-preview');
                img.src = e.target.result;
                img.classList.remove('hidden');
                document.getElementById('webcam-container').innerHTML = "";
                document.getElementById('btn-analyze').classList.remove('hidden');
                document.getElementById('status-text').innerText = "‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function predict() {
        document.getElementById('predict-result').innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...";
        document.getElementById('result-area').style.display = 'block';
        
        let prediction;
        if (document.getElementById('image-preview').classList.contains('hidden')) {
            prediction = await model.predict(webcam.canvas);
            currentImageBase64 = webcam.canvas.toDataURL(); // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á
        } else {
            prediction = await model.predict(document.getElementById('image-preview'));
        }

        // ‡∏´‡∏≤‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
        let topResult = prediction.reduce((prev, current) => (prev.probability > current.probability) ? prev : current);
        
        currentPrediction = {
            className: topResult.className,
            probability: (topResult.probability * 100).toFixed(2)
        };

        document.getElementById('predict-result').innerText = currentPrediction.className;
        document.getElementById('predict-conf').innerText = "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: " + currentPrediction.probability + "%";
    }

    function finishSort() {
        // 1. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        currentUser.score += 1;
        
        // 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
        const now = new Date();
        const historyEntry = {
            img: currentImageBase64,
            type: currentPrediction.className,
            conf: currentPrediction.probability,
            time: now.toLocaleDateString() + " " + now.toLocaleTimeString()
        };
        currentUser.history.unshift(historyEntry);

        // 3. ‡πÄ‡∏ã‡∏ü‡∏•‡∏á localStorage
        let users = JSON.parse(localStorage.getItem('eco_users'));
        users[currentUser.id] = currentUser;
        localStorage.setItem('eco_users', JSON.stringify(users));

        // 4. Reset ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        alert("‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! +1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô");
        document.getElementById('result-area').style.display = 'none';
        document.getElementById('image-preview').classList.add('hidden');
        document.getElementById('webcam-container').innerHTML = "";
        document.getElementById('btn-analyze').classList.add('hidden');
        document.getElementById('status-text').innerText = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ä‡∏¥‡πâ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ";
        
        updateStudentUI();
    }

    function renderHistory() {
        const container = document.getElementById('student-history');
        container.innerHTML = currentUser.history.map(item => `
            <div class="history-item">
                <img src="${item.img}" class="history-img">
                <div>
                    <b>${item.type}</b> (${item.conf}%)<br>
                    <small>${item.time}</small>
                </div>
            </div>
        `).join('');
    }

    // --- Teacher Logic ---
    function authTeacher() {
        const pw = document.getElementById('teacher-pw').value;
        if (pw === 'Eco2026') {
            showPage('page-teacher-dashboard');
        } else {
            alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }
    }

    function renderScoreTable() {
        const users = JSON.parse(localStorage.getItem('eco_users') || '{}');
        const userList = Object.values(users).sort((a, b) => b.score - a.score);
        
        const tbody = document.getElementById('score-body');
        tbody.innerHTML = userList.map(u => `
            <tr>
                <td onclick="viewDetail('${u.id}')" style="color:blue; text-decoration:underline; cursor:pointer;">${u.name}</td>
                <td>${u.room}</td>
                <td><b>${u.score}</b></td>
            </tr>
        `).join('');
    }

    function filterTable() {
        const search = document.getElementById('search-input').value.toLowerCase();
        const roomFilter = document.getElementById('filter-room').value;
        const users = JSON.parse(localStorage.getItem('eco_users') || '{}');
        
        const filtered = Object.values(users)
            .filter(u => (u.name.toLowerCase().includes(search) || u.id.includes(search)) && 
                         (roomFilter === "" || u.room === roomFilter))
            .sort((a, b) => b.score - a.score);

        document.getElementById('score-body').innerHTML = filtered.map(u => `
            <tr>
                <td onclick="viewDetail('${u.id}')" style="color:blue; text-decoration:underline; cursor:pointer;">${u.name}</td>
                <td>${u.room}</td>
                <td><b>${u.score}</b></td>
            </tr>
        `).join('');
    }

    function viewDetail(id) {
        const users = JSON.parse(localStorage.getItem('eco_users'));
        const user = users[id];
        document.getElementById('view-student-name').innerText = "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥: " + user.name;
        document.getElementById('history-detail-list').innerHTML = user.history.map(item => `
            <div class="history-item">
                <img src="${item.img}" class="history-img">
                <div>
                    <b>${item.type}</b> (${item.conf}%)<br>
                    <small>${item.time}</small>
                </div>
            </div>
        `).join('');
        showPage('page-view-history');
    }

    // Initialize Room Filter for Teacher
    const filterSelect = document.getElementById('filter-room');
    rooms.forEach(r => {
        let opt = document.createElement('option');
        opt.value = r; opt.innerText = r;
        filterSelect.appendChild(opt);
    });
</script>

</body>
</html>
