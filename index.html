<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Eco Snap AI</title>

<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<style>
body{
  margin:0;
  font-family: "Segoe UI", sans-serif;
  background:#eaf6ea;
}
.container{
  max-width:420px;
  margin:auto;
  padding:20px;
}
h1{
  text-align:center;
  color:#2e7d32;
}
.card{
  background:#fff;
  border-radius:12px;
  padding:16px;
  margin-top:16px;
  box-shadow:0 4px 10px rgba(0,0,0,.1);
}
button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:8px;
  background:#4caf50;
  color:white;
  font-size:16px;
  margin-top:10px;
}
button:active{opacity:.8}
img{
  max-width:100%;
  border-radius:10px;
  margin-top:10px;
}
#result{
  margin-top:10px;
  padding:10px;
  background:#f1f8f1;
  border-radius:8px;
}
</style>
</head>

<body>
<div class="container">

<h1>Eco Snap AI</h1>

<div class="card">
  <strong>อัปโหลดหรือถ่ายภาพขยะ</strong>
  <input type="file" accept="image/*" id="imageInput"/>
  <img id="preview" />
  <button onclick="analyze()">วิเคราะห์ขยะ</button>
  <div id="result">ยังไม่มีผลการวิเคราะห์</div>
</div>

</div>

<script>
const MODEL_URL = "https://teachablemachine.withgoogle.com/models/UQwja1MPO/";

let model;
let imageData = null;

// โหลดโมเดล
async function loadModel(){
  model = await tmImage.load(
    MODEL_URL + "model.json",
    MODEL_URL + "metadata.json"
  );
  console.log("AI โหลดเสร็จแล้ว");
}
loadModel();

// รับรูป
document.getElementById("imageInput").addEventListener("change", e=>{
  const file = e.target.files[0];
  if(!file) return;

  const img = document.getElementById("preview");
  img.src = URL.createObjectURL(file);
  imageData = img;

  document.getElementById("result").innerHTML = "พร้อมวิเคราะห์แล้ว";
});

// วิเคราะห์ (แก้จุดพังเรียบร้อย)
async function analyze(){
  if(!model){
    alert("AI ยังโหลดไม่เสร็จ");
    return;
  }

  if(!imageData){
    alert("กรุณาเลือกรูปก่อน");
    return;
  }

  if(!imageData.complete){
    imageData.onload = () => analyze();
    return;
  }

  const predictions = await model.predict(imageData);
  predictions.sort((a,b)=>b.probability - a.probability);

  const top = predictions[0];

  document.getElementById("result").innerHTML = `
    <strong>ผลการวิเคราะห์</strong><br>
    ประเภทขยะ: ${top.className}<br>
    ความมั่นใจ: ${(top.probability*100).toFixed(2)}%
  `;
}
</script>

</body>
</html>
