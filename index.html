<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Eco Snap AI</title>
<style>
body { font-family: sans-serif; background:#2e7d32; margin:0; padding:0; color:#fff }
header { padding:10px 20px; display:flex; justify-content:space-between; align-items:center }
.score { background:#fff; color:#2e7d32; padding:6px 12px; border-radius:20px; font-weight:bold }
.container { padding:20px }
.card { background:#e8f5e9; color:#000; border-radius:12px; padding:16px; margin-bottom:16px }
button { padding:10px 16px; border:none; border-radius:8px; cursor:pointer; font-size:16px }
.primary { background:#43a047; color:#fff }
.secondary { background:#fff; color:#2e7d32; border:2px solid #2e7d32 }
input, select { padding:8px; width:100%; margin:6px 0; border-radius:6px; border:1px solid #ccc }
.hidden { display:none }
img.thumb { width:80px; border-radius:6px }
.history-item { display:flex; gap:10px; margin:8px 0; align-items:center }
.white-result { background:#fff; padding:10px; border-radius:8px; margin-top:10px }
</style>
</head>

<body>

<header>
  <h2>üå± Eco Snap AI</h2>
  <div class="score">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span id="score">0</span></div>
</header>

<div class="container">

<!-- LOGIN -->
<div class="card" id="loginCard">
  <h3>‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
  <input id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
  <input id="studentId" placeholder="‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
  <input id="room" placeholder="‡∏´‡πâ‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô 3/1)">
  <input id="teacherCode" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
  <button class="primary" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
</div>

<!-- STUDENT -->
<div id="studentUI" class="hidden">

  <div class="card">
    <h3>‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û / ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ</h3>
    <video id="video" width="240" autoplay></video><br>
    <button class="secondary" onclick="startCamera()">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
    <button class="secondary" onclick="capture()">‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</button>
    <input type="file" accept="image/*" onchange="uploadImage(event)">
    <canvas id="canvas" width="240" height="180" class="hidden"></canvas>
  </div>

  <div class="card">
    <button class="primary" onclick="analyze()">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
    <div id="result" class="white-result hidden"></div>
    <button class="secondary hidden" id="confirmBtn" onclick="confirmWaste()">‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
  </div>

  <div class="card">
    <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
    <div id="history"></div>
  </div>

</div>

<!-- TEACHER -->
<div id="teacherUI" class="hidden">
  <div class="card">
    <h3>‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏£‡∏π</h3>
    <select id="roomFilter" onchange="renderTeacher()"></select>
    <div id="teacherList"></div>
  </div>
</div>

</div>

<script>
let currentUser = null;
let currentImage = null;
let currentType = null;

function login() {
  const code = teacherCode.value.trim();
  if (code === "Eco2026") {
    document.getElementById("loginCard").classList.add("hidden");
    document.getElementById("teacherUI").classList.remove("hidden");
    renderTeacher();
    return;
  }

  if (!name.value || !studentId.value || !room.value) {
    alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    return;
  }

  currentUser = { name: name.value, id: studentId.value, room: room.value };
  saveUser();
  document.getElementById("loginCard").classList.add("hidden");
  document.getElementById("studentUI").classList.remove("hidden");
  loadUser();
}

function saveUser() {
  const db = JSON.parse(localStorage.getItem("ecoDB") || "{}");
  if (!db[currentUser.id]) {
    db[currentUser.id] = { ...currentUser, score:0, history:[] };
    localStorage.setItem("ecoDB", JSON.stringify(db));
  }
}

function loadUser() {
  const db = JSON.parse(localStorage.getItem("ecoDB"));
  const u = db[currentUser.id];
  score.innerText = u.score;
  renderHistory();
}

function startCamera() {
  navigator.mediaDevices.getUserMedia({ video:true }).then(s=>{
    video.srcObject = s;
  });
}

function capture() {
  canvas.getContext("2d").drawImage(video,0,0,240,180);
  currentImage = canvas.toDataURL();
}

function uploadImage(e) {
  const r = new FileReader();
  r.onload = () => currentImage = r.result;
  r.readAsDataURL(e.target.files[0]);
}

function analyze() {
  if (!currentImage) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ"); return; }

  /* üî¥ ‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° AI ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üî¥
     ‡πÅ‡∏Å‡πâ‡πÅ‡∏Ñ‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ ‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô */
  currentType = prediction[0].className; // <-- ‡πÉ‡∏ä‡πâ‡∏ú‡∏• className ‡∏à‡∏≤‡∏Å AI ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ó‡∏ô

  result.innerText = "‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå: " + currentType;
  result.classList.remove("hidden");
  confirmBtn.classList.remove("hidden");
}

function confirmWaste() {
  const db = JSON.parse(localStorage.getItem("ecoDB"));
  const u = db[currentUser.id];

  u.score += 1;
  u.history.push({
    img: currentImage,
    type: currentType,
    time: new Date().toLocaleString()
  });

  localStorage.setItem("ecoDB", JSON.stringify(db));
  score.innerText = u.score;
  renderHistory();

  confirmBtn.classList.add("hidden");
}

function renderHistory() {
  const db = JSON.parse(localStorage.getItem("ecoDB"));
  const u = db[currentUser.id];
  history.innerHTML = "";
  u.history.forEach(h=>{
    history.innerHTML += `
      <div class="history-item">
        <img src="${h.img}" class="thumb">
        <div>${h.type}<br><small>${h.time}</small></div>
      </div>`;
  });
}

function renderTeacher() {
  const db = JSON.parse(localStorage.getItem("ecoDB") || "{}");
  const rooms = [...new Set(Object.values(db).map(u=>u.room))];
  roomFilter.innerHTML = rooms.map(r=>`<option>${r}</option>`).join("");
  teacherList.innerHTML = "";

  Object.values(db)
    .filter(u=>u.room===roomFilter.value)
    .forEach(u=>{
      teacherList.innerHTML += `<div class="card">
        <b>${u.name}</b> (${u.room})<br>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${u.score}
      </div>`;
    });
}
</script>

</body>
</html>
