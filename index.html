<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Eco Snap AI</title>

<!-- AI -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

<style>
body{
  margin:0;
  font-family:sans-serif;
  background:linear-gradient(#dff5e1,#b7e4c7);
}
.page{display:none;padding:20px}
.active{display:block}
h1{text-align:center}
button{
  padding:15px;
  border:none;
  border-radius:30px;
  font-size:18px;
  width:100%;
  margin-top:10px;
}
.role-btn{background:#40916c;color:white}
.card{
  background:white;
  padding:20px;
  border-radius:20px;
  margin-top:15px;
}
.image-box{
  height:220px;
  background:#eee;
  border-radius:15px;
  display:flex;
  justify-content:center;
  align-items:center;
}
.image-box img{max-width:100%;max-height:100%;border-radius:10px}
.score{position:fixed;top:10px;right:15px;font-weight:bold}
.history-card{
  background:#f1f1f1;
  padding:10px;
  border-radius:10px;
  margin-top:10px;
}
.gold{color:gold;font-weight:bold}
</style>
</head>

<body>

<!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó -->
<div id="rolePage" class="page active">
  <h1>üå± Eco Snap AI</h1>
  <p style="text-align:center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
  <button class="role-btn" onclick="goStudent()">üë©‚Äçüéì ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
  <button class="role-btn" onclick="goTeacher()">üë©‚Äçüè´ ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</button>
</div>

<!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô -->
<div id="studentPage" class="page">
  <div class="score">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span id="score">0</span></div>
  <h1>‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞‡∏î‡πâ‡∏ß‡∏¢ AI</h1>

  <div class="card">
    <div class="image-box">
      <span id="placeholder">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</span>
      <img id="preview" style="display:none">
    </div>
    <input type="file" accept="image/*" id="imageInput">
  </div>

  <div class="card">
    <button onclick="analyze()">üß† ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
    <button onclick="saveResult()">‚úÖ ‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
    <div id="result" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <h3>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h3>
    <div id="history"></div>
  </div>
</div>

<!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏π -->
<div id="teacherPage" class="page">
  <h1>üèÜ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h1>
  <div id="leaderboard"></div>
</div>

<script>
/* ====== ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ====== */
function show(page){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(page).classList.add('active');
}
function goStudent(){show('studentPage')}
function goTeacher(){loadTeacher();show('teacherPage')}

/* ====== AI ====== */
const URL="https://teachablemachine.withgoogle.com/models/UQwja1MPO/";
let model;
async function loadModel(){
  if(!model){
    model=await tmImage.load(URL+"model.json",URL+"metadata.json");
  }
}

/* ====== ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ====== */
let currentResult=null;
let score=0;

const imageInput=document.getElementById("imageInput");
const preview=document.getElementById("preview");
const placeholder=document.getElementById("placeholder");
const resultBox=document.getElementById("result");
const historyBox=document.getElementById("history");

imageInput.onchange=()=>{
  const file=imageInput.files[0];
  if(!file)return;
  const r=new FileReader();
  r.onload=()=>{
    preview.src=r.result;
    preview.style.display="block";
    placeholder.style.display="none";
  };
  r.readAsDataURL(file);
};

async function analyze(){
  if(!imageInput.files[0]){
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ");
    return;
  }
  resultBox.innerHTML="‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...";
  await loadModel();
  const p=await model.predict(preview);
  p.sort((a,b)=>b.probability-a.probability);
  currentResult=p[0];
  resultBox.innerHTML=
    `‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${currentResult.className}<br>
     ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: ${(currentResult.probability*100).toFixed(2)}%`;
}

function saveResult(){
  if(!currentResult){
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡πà‡∏≠‡∏ô");
    return;
  }
  score++;
  document.getElementById("score").innerText=score;

  const data=JSON.parse(localStorage.getItem("ecoData")||"[]");
  data.push({
    type:currentResult.className,
    conf:(currentResult.probability*100).toFixed(2),
    time:new Date().toLocaleString(),
    img:preview.src,
    score:score
  });
  localStorage.setItem("ecoData",JSON.stringify(data));

  renderHistory();
  resetInput();
}

function renderHistory(){
  historyBox.innerHTML="";
  const data=JSON.parse(localStorage.getItem("ecoData")||"[]");
  data.forEach(d=>{
    historyBox.innerHTML+=`
      <div class="history-card">
        <img src="${d.img}" width="80"><br>
        ${d.type} (${d.conf}%)<br>
        ${d.time}
      </div>`;
  });
}

function resetInput(){
  imageInput.value="";
  preview.style.display="none";
  placeholder.style.display="block";
  resultBox.innerHTML="";
  currentResult=null;
}

/* ====== ‡∏Ñ‡∏£‡∏π ====== */
function loadTeacher(){
  const box=document.getElementById("leaderboard");
  box.innerHTML="";
  const data=JSON.parse(localStorage.getItem("ecoData")||"[]");
  if(data.length===0){
    box.innerHTML="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
    return;
  }
  data.forEach((d,i)=>{
    box.innerHTML+=`
      <div class="${i<3?'gold':''}">
        ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö ${i+1} : ${d.type} | ${d.score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
      </div>`;
  });
}
</script>

</body>
</html>
