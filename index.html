<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco Snap AI - ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏ö‡∏ö</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #7ED957; --secondary: #FFDE59; --bg: #F0FDF4; }
        body { font-family: 'Mitr', sans-serif; background-color: #f7f7f7; margin: 0; display: flex; justify-content: center; }
        .mobile-layout { width: 100%; max-width: 414px; background: white; min-height: 100vh; position: relative; box-sizing: border-box; padding: 20px; overflow-x: hidden; }
        .hidden { display: none !important; }
        .btn { width: 100%; padding: 15px; border-radius: 20px; border: none; font-size: 16px; font-weight: 500; cursor: pointer; margin-top: 10px; transition: 0.2s; font-family: 'Mitr'; }
        .btn-green { background: var(--primary); color: white; box-shadow: 0 4px 0 #66b046; }
        .btn-yellow { background: var(--secondary); color: #5d4037; box-shadow: 0 4px 0 #e6c850; }
        .btn-back { width: auto; padding: 5px 15px; position: absolute; top: 15px; left: 15px; font-size: 12px; z-index: 10; background: #eee; border-radius: 10px; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #eee; border-radius: 15px; font-family: 'Mitr'; box-sizing: border-box; }
        .score-badge { background: #e8f5e9; color: #2e7d32; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 18px; }
        .upload-zone { border: 3px dashed var(--primary); border-radius: 25px; padding: 20px; text-align: center; margin: 20px 0; min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .result-card { border: 2px solid var(--primary); border-radius: 20px; padding: 15px; background: #f9fff9; margin-top: 15px; text-align: center; animation: pulse 1s infinite alternate; }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.02); } }
        .history-card { display: flex; align-items: center; background: #fff; border: 1px solid #eee; padding: 10px; border-radius: 15px; margin-bottom: 10px; }
        .history-img { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; margin-right: 15px; }
        table { width: 100%; margin-top: 15px; border-spacing: 0; }
        th { background: #f8f9fa; padding: 10px; text-align: left; font-size: 14px; }
        td { padding: 12px 10px; border-bottom: 1px solid #eee; font-size: 14px; }
    </style>
</head>
<body>

<div class="mobile-layout">
    <div id="page-role" class="page-content">
        <h1 style="text-align:center; color: var(--primary); margin-top: 50px;">Eco Snap AI üåø</h1>
        <p style="text-align:center; color: #666;">‡∏ä‡πà‡∏ß‡∏¢‡πÇ‡∏•‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞‡∏Å‡∏±‡∏ô‡∏ô‡∏∞!</p>
        <div style="margin-top: 40px;">
            <button class="btn btn-green" onclick="goTo('page-login')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)</button>
            <button class="btn btn-yellow" onclick="goTo('page-teacher-auth')">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</button>
        </div>
    </div>

    <div id="page-login" class="page-content hidden">
        <button class="btn btn-back" onclick="goTo('page-role')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <h2 style="margin-top: 60px;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
        <input type="text" id="reg-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
        <input type="number" id="reg-id" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß 5 ‡∏´‡∏•‡∏±‡∏Å" oninput="checkForm()">
        <select id="reg-room" onchange="checkForm()">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
            <script>
                const rooms = ['1/1','1/2','1/3','1/4','1/5','2/1','2/2','2/3','2/4','2/5','3/1','3/2','3/3','3/4','4/1','4/2','4/3','5/1','5/2','5/3','5/4','6/1','6/2','6/3'];
                rooms.forEach(r => document.write(`<option value="${r}">${r}</option>`));
            </script>
        </select>
        <button id="btn-submit-login" class="btn btn-green" disabled onclick="doLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div id="page-student-main" class="page-content hidden">
        <button class="btn btn-back" onclick="goTo('page-role')">‡∏≠‡∏≠‡∏Å</button>
        <div style="display:flex; justify-content: space-between; align-items: center; margin-top: 40px;">
            <div>
                <b id="user-display-name">---</b><br>
                <small id="user-display-room">‡∏´‡πâ‡∏≠‡∏á --</small>
            </div>
            <div class="score-badge">‚ú® <span id="user-display-score">0</span></div>
        </div>

        <div class="upload-zone" id="upload-zone">
            <div id="webcam-container"></div>
            <img id="preview-img" class="hidden" style="width:100%; border-radius:15px;">
            <p id="label-prompt">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏Ç‡∏¢‡∏∞</p>
        </div>

        <div id="analysis-result" class="result-card hidden">
            <h3 style="margin:0">‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå: <span id="res-type" style="color:var(--primary)">...</span></h3>
            <p style="margin:5px 0">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: <span id="res-conf">0</span>%</p>
            <button class="btn btn-green" onclick="saveTrash()">‚úÖ ‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
        </div>

        <div id="action-buttons">
            <button class="btn btn-yellow" onclick="startCam()">üì∏ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</button>
            <button class="btn btn-green" style="background:#4a90e2; box-shadow: 0 4px 0 #357abd;" onclick="document.getElementById('file-input').click()">üìÅ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
            <input type="file" id="file-input" class="hidden" accept="image/*" onchange="handleFile(this)">
            <button id="btn-predict" class="btn btn-green hidden" onclick="runAI()">üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡∏¢‡∏∞</button>
        </div>

        <h3 style="margin-top:30px; border-bottom: 2px solid var(--primary); display:inline-block;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
        <div id="history-list" style="margin-top:15px;"></div>
    </div>

    <div id="page-teacher-auth" class="page-content hidden">
        <button class="btn btn-back" onclick="goTo('page-role')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <h2 style="margin-top: 60px;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</h2>
        <input type="password" id="t-pass" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô">
        <button class="btn btn-green" onclick="loginTeacher()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
    </div>

    <div id="page-teacher-main" class="page-content hidden">
        <button class="btn btn-back" onclick="goTo('page-role')">‡∏≠‡∏≠‡∏Å</button>
        <h2 style="margin-top: 60px; color: var(--primary);">Eco Points üèÜ</h2>
        
        <input type="text" id="search-box" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™..." onkeyup="renderTeacherTable()">
        <select id="filter-room" onchange="renderTeacherTable()">
            <option value="">‡∏î‡∏π‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
            <script>rooms.forEach(r => document.write(`<option value="${r}">${r}</option>`));</script>
        </select>

        <table>
            <thead>
                <tr><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th></tr>
            </thead>
            <tbody id="teacher-table-body"></tbody>
        </table>
    </div>

    <div id="page-student-detail" class="page-content hidden">
        <button class="btn btn-back" onclick="goTo('page-teacher-main')">‡∏Å‡∏•‡∏±‡∏ö</button>
        <h2 id="detail-title" style="margin-top: 60px;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏¢‡∏∞</h2>
        <div id="detail-history-list"></div>
    </div>
</div>

<script>
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/UQwja1MPO/";
    let model, webcam, currentImage, currentResult;
    let currentUserData = null;

    // --- Core Logic ---
    function goTo(pageId) {
        document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
        document.getElementById(pageId).classList.remove('hidden');
        if(pageId === 'page-teacher-main') renderTeacherTable();
    }

    function checkForm() {
        const name = document.getElementById('reg-name').value;
        const id = document.getElementById('reg-id').value;
        const room = document.getElementById('reg-room').value;
        document.getElementById('btn-submit-login').disabled = !(name && id.length === 5 && room);
    }

    function doLogin() {
        const id = document.getElementById('reg-id').value;
        let allUsers = JSON.parse(localStorage.getItem('eco_users') || '{}');
        
        if (!allUsers[id]) {
            allUsers[id] = {
                id: id,
                name: document.getElementById('reg-name').value,
                room: document.getElementById('reg-room').value,
                score: 0,
                history: []
            };
            localStorage.setItem('eco_users', JSON.stringify(allUsers));
        }
        currentUserData = allUsers[id];
        initApp();
    }

    async function initApp() {
        document.getElementById('user-display-name').innerText = currentUserData.name;
        document.getElementById('user-display-room').innerText = "‡∏´‡πâ‡∏≠‡∏á " + currentUserData.room;
        document.getElementById('user-display-score').innerText = currentUserData.score;
        updateHistoryUI();
        goTo('page-student-main');
        model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
    }

    // --- AI & Camera ---
    async function startCam() {
        document.getElementById('label-prompt').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...";
        webcam = new tmImage.Webcam(300, 300, false);
        await webcam.setup({ facingMode: "environment" });
        await webcam.play();
        document.getElementById('webcam-container').innerHTML = "";
        document.getElementById('webcam-container').appendChild(webcam.canvas);
        document.getElementById('preview-img').classList.add('hidden');
        document.getElementById('btn-predict').classList.remove('hidden');
    }

    function handleFile(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                currentImage = e.target.result;
                const img = document.getElementById('preview-img');
                img.src = e.target.result;
                img.classList.remove('hidden');
                document.getElementById('webcam-container').innerHTML = "";
                document.getElementById('btn-predict').classList.remove('hidden');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function runAI() {
        document.getElementById('res-type').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...";
        document.getElementById('analysis-result').classList.remove('hidden');
        
        let prediction;
        const imgElement = document.getElementById('preview-img');
        
        if (!imgElement.classList.contains('hidden')) {
            prediction = await model.predict(imgElement);
        } else {
            prediction = await model.predict(webcam.canvas);
            currentImage = webcam.canvas.toDataURL();
        }

        const top = prediction.reduce((prev, curr) => (prev.probability > curr.probability) ? prev : curr);
        currentResult = { type: top.className, conf: (top.probability * 100).toFixed(1) };
        
        document.getElementById('res-type').innerText = currentResult.type;
        document.getElementById('res-conf').innerText = currentResult.conf;
    }

    // --- ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß ---
    function saveTrash() {
        // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å localStorage ‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô (‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î)
        let allUsers = JSON.parse(localStorage.getItem('eco_users') || '{}');
        let user = allUsers[currentUserData.id];

        // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤
        const now = new Date();
        const record = {
            img: currentImage,
            type: currentResult.type,
            conf: currentResult.conf,
            date: now.toLocaleDateString('th-TH'),
            time: now.toLocaleTimeString('th-TH')
        };

        user.score += 1;
        user.history.unshift(record); // ‡πÉ‡∏™‡πà‡πÑ‡∏ß‡πâ‡∏ö‡∏ô‡∏™‡∏∏‡∏î

        // 3. ‡πÄ‡∏ã‡∏ü‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ localStorage ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        allUsers[currentUserData.id] = user;
        localStorage.setItem('eco_users', JSON.stringify(allUsers));
        
        // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà
        currentUserData = user;

        // 5. Reset ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! +1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô");
        document.getElementById('analysis-result').classList.add('hidden');
        document.getElementById('preview-img').classList.add('hidden');
        document.getElementById('webcam-container').innerHTML = "";
        document.getElementById('btn-predict').classList.add('hidden');
        document.getElementById('label-prompt').innerText = "‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏Ç‡∏¢‡∏∞";
        
        // 6. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
        document.getElementById('user-display-score').innerText = user.score;
        updateHistoryUI();
    }

    function updateHistoryUI() {
        const list = document.getElementById('history-list');
        list.innerHTML = currentUserData.history.map(item => `
            <div class="history-card">
                <img src="${item.img}" class="history-img">
                <div>
                    <b>${item.type}</b> <small>(${item.conf}%)</small><br>
                    <small style="color: #888;">${item.date} ${item.time}</small>
                </div>
            </div>
        `).join('');
    }

    // --- Teacher Part ---
    function loginTeacher() {
        if(document.getElementById('t-pass').value === 'Eco2026') {
            goTo('page-teacher-main');
        } else {
            alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }
    }

    function renderTeacherTable() {
        const allUsers = JSON.parse(localStorage.getItem('eco_users') || '{}');
        const search = document.getElementById('search-box').value.toLowerCase();
        const roomF = document.getElementById('filter-room').value;
        
        const list = Object.values(allUsers)
            .filter(u => (u.name.toLowerCase().includes(search) || u.id.includes(search)) && (roomF === "" || u.room === roomF))
            .sort((a, b) => b.score - a.score);

        document.getElementById('teacher-table-body').innerHTML = list.map(u => `
            <tr onclick="showStudentDetail('${u.id}')" style="cursor:pointer">
                <td>${u.name}</td>
                <td>${u.room}</td>
                <td><b>${u.score}</b></td>
            </tr>
        `).join('');
    }

    function showStudentDetail(id) {
        const allUsers = JSON.parse(localStorage.getItem('eco_users') || '{}');
        const user = allUsers[id];
        if(!user) return;

        document.getElementById('detail-title').innerText = "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥: " + user.name;
        const list = document.getElementById('detail-history-list');
        list.innerHTML = user.history.length > 0 ? user.history.map(item => `
            <div class="history-card">
                <img src="${item.img}" class="history-img">
                <div>
                    <b>${item.type}</b> <small>(${item.conf}%)</small><br>
                    <small>${item.date} ${item.time}</small>
                </div>
            </div>
        `).join('') : "<p style='text-align:center'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡πÅ‡∏¢‡∏Å</p>";
        
        goTo('page-student-detail');
    }
</script>
</body>
</html>
