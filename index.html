<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>Eco Snap AI</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest"></script>

<style>
body { font-family: sans-serif; margin:0; background:#e8f5e9; }
header { background:#2e7d32; color:white; padding:10px; display:flex; align-items:center; justify-content:space-between; }
.hidden { display:none; }
.container { padding:15px; }
button { padding:10px; margin:5px 0; width:100%; font-size:16px; }
input, select { padding:8px; width:100%; margin:5px 0; }
.card { background:white; padding:10px; margin:10px 0; border-radius:8px; }
.resultBox { border:2px solid #2e7d32; padding:10px; border-radius:8px; }
.history { display:grid; grid-template-columns:repeat(auto-fill,120px); gap:10px; }
.history img { width:100%; border-radius:6px; }
.back { cursor:pointer; font-size:20px; }
.score { font-weight:bold; }
table { width:100%; border-collapse:collapse; }
th,td { border:1px solid #ccc; padding:6px; text-align:center; }
</style>
</head>

<body>

<header>
<span class="back hidden" onclick="goHome()">⬅</span>
<span id="appTitle">Eco Snap AI</span>
<span class="score" id="score"></span>
</header>

<div class="container">

<!-- ROLE -->
<div id="role">
<h2>เข้าสู่ระบบ</h2>
<button onclick="chooseRole('student')">นักเรียน</button>
<button onclick="chooseRole('teacher')">คุณครู</button>
</div>

<!-- STUDENT LOGIN -->
<div id="studentLogin" class="hidden">
<input id="sname" placeholder="ชื่อ-นามสกุล">
<input id="sid" placeholder="รหัสนักเรียน 5 หลัก" maxlength="5">
<select id="sclass">
<option value="">เลือกห้อง</option>
<option>1/1</option><option>1/2</option><option>1/3</option><option>1/4</option><option>1/5</option>
<option>2/1</option><option>2/2</option><option>2/3</option><option>2/4</option><option>2/5</option>
<option>3/1</option><option>3/2</option><option>3/3</option><option>3/4</option>
<option>4/1</option><option>4/2</option><option>4/3</option>
<option>5/1</option><option>5/2</option><option>5/3</option><option>5/4</option>
<option>6/1</option><option>6/2</option><option>6/3</option>
</select>
<button onclick="loginStudent()">เข้าสู่ระบบ</button>
</div>

<!-- ANALYSIS -->
<div id="analysis" class="hidden">
<h3>วิเคราะห์ขยะ</h3>
<input type="file" id="imgInput" accept="image/*">
<img id="preview" width="100%" />
<button onclick="analyze()">วิเคราะห์</button>

<div id="loading" class="hidden">⏳ กำลังวิเคราะห์...</div>

<div id="result" class="hidden resultBox"></div>
<button id="confirmBtn" class="hidden" onclick="confirmTrash()">แยกขยะเสร็จแล้ว</button>

<h3>ประวัติ</h3>
<div id="history" class="history"></div>
</div>

<!-- TEACHER LOGIN -->
<div id="teacherLogin" class="hidden">
<input id="teacherPass" placeholder="รหัสคุณครู">
<button onclick="loginTeacher()">เข้าสู่ระบบ</button>
</div>

<!-- TEACHER SCORE -->
<div id="teacherPage" class="hidden">
<h3>Eco Point</h3>
<input placeholder="ค้นหาชื่อหรือรหัส" oninput="searchStudent(this.value)">
<select onchange="filterClass(this.value)">
<option value="">ทุกห้อง</option>
<option>1/1</option><option>1/2</option><option>1/3</option><option>1/4</option><option>1/5</option>
<option>2/1</option><option>2/2</option><option>2/3</option><option>2/4</option><option>2/5</option>
<option>3/1</option><option>3/2</option><option>3/3</option><option>3/4</option>
<option>4/1</option><option>4/2</option><option>4/3</option>
<option>5/1</option><option>5/2</option><option>5/3</option><option>5/4</option>
<option>6/1</option><option>6/2</option><option>6/3</option>
</select>

<table>
<thead><tr><th>ชื่อ</th><th>ห้อง</th><th>คะแนน</th></tr></thead>
<tbody id="scoreTable"></tbody>
</table>
</div>

</div>

<script>
const MODEL_URL = "https://teachablemachine.withgoogle.com/models/UQwja1MPO/";
let model, currentUser, prediction;

function chooseRole(r){
document.getElementById("role").classList.add("hidden");
document.querySelector(".back").classList.remove("hidden");
if(r==="student") studentLogin.classList.remove("hidden");
else teacherLogin.classList.remove("hidden");
}

function goHome(){
location.reload();
}

function loginStudent(){
if(!sname.value || sid.value.length!==5 || !sclass.value){
alert("กรอกข้อมูลให้ครบ");
return;
}
let users = JSON.parse(localStorage.getItem("users")||"{}");
if(!users[sid.value]){
users[sid.value]={name:sname.value,class:sclass.value,score:0,history:[]};
localStorage.setItem("users",JSON.stringify(users));
}
currentUser=sid.value;
studentLogin.classList.add("hidden");
analysis.classList.remove("hidden");
score.innerText="คะแนน: "+users[currentUser].score;
}

async function analyze(){
loading.classList.remove("hidden");
if(!model){
model = await tmImage.load(MODEL_URL+"model.json",MODEL_URL+"metadata.json");
}
prediction = await model.predict(preview);
let best = prediction.reduce((a,b)=>a.probability>b.probability?a:b);
result.innerHTML=`<b>ผลวิเคราะห์</b><br>ประเภท: ${best.className}<br>มั่นใจ: ${(best.probability*100).toFixed(2)}%`;
loading.classList.add("hidden");
result.classList.remove("hidden");
confirmBtn.classList.remove("hidden");
}

function confirmTrash(){
let users = JSON.parse(localStorage.getItem("users"));
let now=new Date().toLocaleString();
users[currentUser].score+=1;
users[currentUser].history.push({
img:preview.src,
type:prediction[0].className,
time:now
});
localStorage.setItem("users",JSON.stringify(users));
score.innerText="คะแนน: "+users[currentUser].score;
loadHistory();
result.classList.add("hidden");
confirmBtn.classList.add("hidden");
}

function loadHistory(){
history.innerHTML="";
let users = JSON.parse(localStorage.getItem("users"));
users[currentUser].history.forEach(h=>{
history.innerHTML+=`<div><img src="${h.img}"><small>${h.type}<br>${h.time}</small></div>`;
});
}

function loginTeacher(){
if(teacherPass.value!=="Eco2026"){alert("รหัสผิด");return;}
teacherLogin.classList.add("hidden");
teacherPage.classList.remove("hidden");
loadScore();
}

function loadScore(filter=""){
let users = JSON.parse(localStorage.getItem("users")||"{}");
let arr=Object.values(users).sort((a,b)=>b.score-a.score);
scoreTable.innerHTML="";
arr.forEach(u=>{
if(filter && u.class!==filter) return;
scoreTable.innerHTML+=`<tr><td>${u.name}</td><td>${u.class}</td><td>${u.score}</td></tr>`;
});
}

function searchStudent(q){
loadScore();
if(!q) return;
[...scoreTable.rows].forEach(r=>{
if(!r.innerText.includes(q)) r.style.display="none";
});
}

function filterClass(c){ loadScore(c); }
</script>

</body>
</html>
