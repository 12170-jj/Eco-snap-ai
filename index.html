<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Eco Snap AI</title>

<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<style>
body{
  margin:0;
  font-family: "Prompt", sans-serif;
  background:#f4fff8;
}
.container{
  max-width:420px;
  margin:auto;
  padding:16px;
}
.card{
  background:white;
  border-radius:16px;
  padding:16px;
  margin-bottom:12px;
  box-shadow:0 4px 10px rgba(0,0,0,.08);
}
button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:12px;
  background:#2ecc71;
  color:white;
  font-size:16px;
}
button:disabled{
  background:#ccc;
}
input,select{
  width:100%;
  padding:10px;
  margin-top:8px;
  border-radius:10px;
  border:1px solid #ccc;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}
.score{
  background:#27ae60;
  color:white;
  padding:6px 12px;
  border-radius:999px;
}
.history-item{
  border:1px solid #ddd;
  border-radius:12px;
  padding:8px;
  margin-bottom:8px;
}
img{
  width:100%;
  border-radius:10px;
}
</style>
</head>

<body>
<div class="container" id="app"></div>

<script>
const MODEL_URL = "https://teachablemachine.withgoogle.com/models/UQwja1MPO/";

let model, predictionResult = null, currentImage = null;

// ---------- UTIL ----------
function save(key,data){
  localStorage.setItem(key, JSON.stringify(data));
}
function load(key){
  return JSON.parse(localStorage.getItem(key));
}

// ---------- ROLE SELECT ----------
function rolePage(){
  app.innerHTML = `
  <div class="card">
    <h2>Eco Snap AI</h2>
    <button onclick="studentLogin()">นักเรียน</button><br><br>
    <button onclick="teacherLogin()">คุณครู</button>
  </div>`;
}

// ---------- STUDENT LOGIN ----------
function studentLogin(){
  app.innerHTML = `
  <div class="card">
    <h3>เข้าสู่ระบบนักเรียน</h3>
    <input id="name" placeholder="ชื่อ-นามสกุล">
    <input id="id" placeholder="รหัสนักเรียน (5 หลัก)">
    <select id="room">
      <option value="">เลือกห้อง</option>
      ${["1/1","1/2","1/3","1/4","1/5","2/1","2/2","2/3","2/4","2/5","3/1","3/2","3/3","3/4","4/1","4/2","4/3","5/1","5/2","5/3","5/4","6/1","6/2","6/3"].map(r=>`<option>${r}</option>`).join("")}
    </select><br><br>
    <button onclick="enterStudent()">เข้าสู่ระบบ</button>
    <br><br><button onclick="rolePage()">ย้อนกลับ</button>
  </div>`;
}

// ---------- ENTER STUDENT ----------
function enterStudent(){
  const name = name.value.trim();
  const id = id.value.trim();
  const room = room.value;

  if(!name || id.length!==5 || !room) return alert("กรอกข้อมูลให้ครบ");

  let students = load("students") || {};
  if(!students[id]){
    students[id]={name,room,score:0,history:[]};
    save("students",students);
  }
  save("currentStudent",id);
  analysisPage();
}

// ---------- ANALYSIS PAGE ----------
async function analysisPage(){
  const id = load("currentStudent");
  const students = load("students");
  const s = students[id];

  app.innerHTML = `
  <header>
    <button onclick="rolePage()">⬅</button>
    <div>${s.name} (${s.room})</div>
    <div class="score">⭐ ${s.score}</div>
  </header>

  <div class="card">
    <input type="file" accept="image/*" capture="environment" onchange="loadImage(event)">
    <div id="preview"></div>
    <button onclick="analyze()">วิเคราะห์</button>
    <div id="result"></div>
    <button onclick="confirm()" id="confirmBtn" disabled>แยกขยะเสร็จแล้ว</button>
  </div>

  <div class="card">
    <h4>ประวัติ</h4>
    ${s.history.map(h=>`
      <div class="history-item">
        <img src="${h.img}">
        <div>${h.type} (${h.confidence}%)</div>
        <div>${h.time}</div>
      </div>`).join("")}
  </div>`;
}

// ---------- IMAGE ----------
function loadImage(e){
  const reader = new FileReader();
  reader.onload = ()=> {
    currentImage = reader.result;
    preview.innerHTML = `<img src="${currentImage}">`;
  };
  reader.readAsDataURL(e.target.files[0]);
}

// ---------- ANALYZE ----------
async function analyze(){
  result.innerText = "กำลังวิเคราะห์...";
  if(!model){
    model = await tmImage.load(MODEL_URL+"model.json", MODEL_URL+"metadata.json");
  }
  const img = document.querySelector("img");
  const preds = await model.predict(img);
  const best = preds.sort((a,b)=>b.probability-a.probability)[0];

  predictionResult = {
    type: best.className,
    confidence: (best.probability*100).toFixed(2)
  };

  result.innerHTML = `<b>ผลวิเคราะห์:</b> ${predictionResult.type}<br>มั่นใจ ${predictionResult.confidence}%`;
  confirmBtn.disabled = false;
}

// ---------- CONFIRM ----------
function confirm(){
  const id = load("currentStudent");
  let students = load("students");

  const record = {
    img: currentImage,
    type: predictionResult.type,
    confidence: predictionResult.confidence,
    time: new Date().toLocaleString()
  };

  students[id].history.unshift(record);
  students[id].score += 1;

  save("students",students);

  // RESET สำคัญมาก
  predictionResult = null;
  currentImage = null;

  analysisPage();
}

// ---------- TEACHER ----------
function teacherLogin(){
  const code = prompt("รหัสยืนยันตัวตน");
  if(code!=="Eco2026") return alert("รหัสไม่ถูกต้อง");
  teacherPage();
}

function teacherPage(){
  const students = load("students") || {};
  const list = Object.values(students).sort((a,b)=>b.score-a.score);

  app.innerHTML = `
  <h3>Eco Point</h3>
  <button onclick="rolePage()">ย้อนกลับ</button>
  ${list.map(s=>`
    <div class="card">
      <b>${s.name}</b> (${s.room})<br>
      คะแนน: ${s.score}
      ${s.history.map(h=>`
        <div class="history-item">
          <img src="${h.img}">
          ${h.type} ${h.confidence}%
        </div>`).join("")}
    </div>`).join("")}`;
}

rolePage();
</script>
</body>
</html>
