<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Eco Snap AI</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

<style>
body{
  margin:0;font-family:sans-serif;
  background:#e9f5ec;
}
.hidden{display:none}
.card{
  background:#fff;border-radius:20px;
  padding:20px;margin:20px;
}
button{
  width:100%;padding:15px;
  border:none;border-radius:30px;
  background:#66bb6a;color:#fff;
  font-size:18px;margin-top:10px;
}
input,select{
  width:100%;padding:12px;
  border-radius:12px;border:1px solid #ccc;
  margin-bottom:10px;
}
.topbar{
  display:flex;justify-content:space-between;
  align-items:center;
}
.score{
  background:#66bb6a;color:#fff;
  padding:8px 14px;border-radius:20px;
}
.image-box{
  background:#c8e6c9;height:240px;
  border-radius:15px;
  display:flex;align-items:center;justify-content:center;
}
.image-box img{max-height:100%;max-width:100%}
.history-item{
  border:1px solid #ddd;border-radius:15px;
  padding:10px;margin-top:10px;
}
</style>
</head>

<body>

<!-- ROLE -->
<div id="role" class="card">
  <h2>üå± Eco Snap AI</h2>
  <button onclick="selectRole('student')">üë©‚Äçüéì ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
  <button onclick="selectRole('teacher')">üë®‚Äçüè´ ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</button>
</div>

<!-- STUDENT LOGIN -->
<div id="studentLogin" class="card hidden">
  <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
  <input id="sName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
  <input id="sId" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
  <select id="sClass">
    <option>‡∏°.1/1</option><option>‡∏°.1/2</option><option>‡∏°.1/3</option><option>‡∏°.1/4</option><option>‡∏°.1/5</option>
    <option>‡∏°.2/1</option><option>‡∏°.2/2</option><option>‡∏°.2/3</option><option>‡∏°.2/4</option><option>‡∏°.2/5</option>
    <option>‡∏°.3/1</option><option>‡∏°.3/2</option><option>‡∏°.3/3</option><option>‡∏°.3/4</option>
    <option>‡∏°.4/1</option><option>‡∏°.4/2</option><option>‡∏°.4/3</option>
    <option>‡∏°.5/1</option><option>‡∏°.5/2</option><option>‡∏°.5/3</option><option>‡∏°.5/4</option>
    <option>‡∏°.6/1</option><option>‡∏°.6/2</option><option>‡∏°.6/3</option>
  </select>
  <button onclick="enterStudent()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
</div>

<!-- STUDENT -->
<div id="studentPage" class="card hidden">
  <div class="topbar">
    <b id="studentName"></b>
    <div class="score">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span id="score">0</span></div>
  </div>

  <div class="image-box">
    <span id="imgText">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</span>
    <img id="preview" class="hidden">
  </div>
  <input type="file" accept="image/*" id="imgInput">

  <button onclick="analyze()">üß† ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
  <button onclick="saveResult()">‚úÖ ‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>

  <div id="result"></div>

  <h4>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h4>
  <div id="history"></div>
</div>

<!-- TEACHER -->
<div id="teacherPage" class="card hidden">
  <h3>üìä ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
  <div id="teacherList"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<script>
/* ===== AI ===== */
const URL = "https://teachablemachine.withgoogle.com/models/‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏Ç‡∏≠‡∏á‡πÄ‡∏ò‡∏≠/";
let model, currentPrediction = null;

/* ===== ‡πÇ‡∏´‡∏•‡∏î AI ===== */
async function loadModel(){
  model = await tmImage.load(URL + "model.json", URL + "metadata.json");
}
loadModel();

/* ===== ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó ===== */
function selectRole(r){
  document.getElementById("role").classList.add("hidden");

  if(r === "student"){
    document.getElementById("studentLogin").classList.remove("hidden");
  }else{
    document.getElementById("teacherPage").classList.remove("hidden");
    loadTeacher();
  }
}

/* ===== ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ ===== */
function enterStudent(){
  const name = document.getElementById("sName").value;
  const id   = document.getElementById("sId").value;
  const cls  = document.getElementById("sClass").value;

  if(!name || !id){
    alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    return;
  }

  sessionStorage.sid = id;
  const key = "stu_" + id;

  if(!localStorage[key]){
    localStorage[key] = JSON.stringify({
      name: name,
      class: cls,
      history: []
    });
  }

  document.getElementById("studentLogin").classList.add("hidden");
  document.getElementById("studentPage").classList.remove("hidden");
  document.getElementById("analyzePage").classList.remove("hidden");

  loadStudent();
}

/* ===== ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ===== */
function loadStudent(){
  const data = JSON.parse(localStorage["stu_" + sessionStorage.sid]);
  document.getElementById("studentName").innerText = data.name;
  document.getElementById("studentClass").innerText = data.class;
}

/* ===== ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ===== */
async function analyze(){
  if(!model){
    alert("AI ‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à");
    return;
  }

  const img = document.getElementById("imagePreview");
  const prediction = await model.predict(img);

  prediction.sort((a,b)=>b.probability-a.probability);
  const best = prediction[0];

  currentPrediction = best.className;

  document.getElementById("result").innerText =
    best.className + " (" + (best.probability*100).toFixed(1) + "%)";
}

/* ===== ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏• ===== */
function saveResult(){
  if(!currentPrediction){
    alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå");
    return;
  }

  const key = "stu_" + sessionStorage.sid;
  const data = JSON.parse(localStorage[key]);

  data.history.push({
    type: currentPrediction,
    time: new Date().toLocaleString()
  });

  localStorage[key] = JSON.stringify(data);

  resetAnalyze();
  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
}

/* ===== ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ ===== */
function resetAnalyze(){
  currentPrediction = null;
  document.getElementById("result").innerText = "";
  document.getElementById("imagePreview").src = "";
}

/* ===== ‡∏Ñ‡∏£‡∏π‡∏î‡∏π‡∏ú‡∏•‡∏£‡∏ß‡∏° ===== */
function loadTeacher(){
  const list = document.getElementById("teacherList");
  list.innerHTML = "";

  for(let key in localStorage){
    if(key.startsWith("stu_")){
      const s = JSON.parse(localStorage[key]);

      let count = {};
      s.history.forEach(h=>{
        count[h.type] = (count[h.type] || 0) + 1;
      });

      let text = `<b>${s.name}</b> (${s.class})<br>`;
      for(let k in count){
        text += `- ${k}: ${count[k]} ‡∏ä‡∏¥‡πâ‡∏ô<br>`;
      }

      list.innerHTML += `<div class="card">${text}</div>`;
    }
  }
}
</script>

imgInput.onchange=e=>{
  const f=e.target.files[0];
  if(!f)return;
  const r=new FileReader();
  r.onload=()=>{preview.src=r.result;preview.classList.remove("hidden");imgText.style.display="none";}
  r.readAsDataURL(f);
}

async function analyze(){
  if(!imgInput.files[0]) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô");
  result.innerText="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...";
  if(!model) model=await tmImage.load(URL+"model.json",URL+"metadata.json");
  const p=await model.predict(preview);
  p.sort((a,b)=>b.probability-a.probability);
  currentPrediction=p[0];
  result.innerHTML=`‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${p[0].className}<br>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: ${(p[0].probability*100).toFixed(2)}%`;
}

function saveResult(){
  if(!currentPrediction) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå");
  const key="stu_"+sessionStorage.sid;
  const data=JSON.parse(localStorage[key]);
  data.score++;
  data.history.unshift({
    img:preview.src,
    type:currentPrediction.className,
    conf:(currentPrediction.probability*100).toFixed(2),
    time:new Date().toLocaleString()
  });
  localStorage[key]=JSON.stringify(data);
  imgInput.value="";preview.classList.add("hidden");
  imgText.style.display="block";result.innerHTML="";currentPrediction=null;
  loadStudent();
}

function loadTeacher(){
  teacherList.innerHTML="";
  Object.keys(localStorage).filter(k=>k.startsWith("stu_"))
  .map(k=>JSON.parse(localStorage[k]))
  .sort((a,b)=>b.score-a.score)
  .forEach(s=>{
    teacherList.innerHTML+=`<div>${s.name} (${s.cls}) ‚Äî ${s.score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>`;
  });
}
</script>
</body>
</html>
