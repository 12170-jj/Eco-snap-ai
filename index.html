<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco Snap AI - ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏Ñ‡∏±‡∏î‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4CAF50;
            --secondary: #FFEB3B;
            --accent: #FF9800;
            --bg: #F1F8E9;
            --white: #ffffff;
            --text: #333;
        }

        * { box-sizing: border-box; font-family: 'Kanit', sans-serif; }
        body { margin: 0; background-color: var(--bg); color: var(--text); overflow-x: hidden; }

        .container { max-width: 500px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; padding: 20px; position: relative; }
        .card { background: var(--white); padding: 20px; border-radius: 20px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); text-align: center; margin-bottom: 20px; }
        
        h1 { color: var(--primary); font-size: 28px; margin-bottom: 10px; }
        button { 
            background: var(--primary); color: white; border: none; padding: 12px 25px; 
            border-radius: 50px; font-size: 18px; cursor: pointer; transition: 0.3s; width: 100%; margin: 10px 0;
            box-shadow: 0 4px 0 #388E3C;
        }
        button:active { transform: translateY(4px); box-shadow: none; }
        button.secondary { background: var(--accent); box-shadow: 0 4px 0 #E65100; }
        
        input, select { 
            width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; 
            border: 2px solid #ddd; font-size: 16px; outline: none;
        }

        /* UI Elements */
        .hidden { display: none !important; }
        .back-btn { position: absolute; top: 20px; left: 20px; width: auto; padding: 5px 15px; font-size: 14px; z-index: 100; }
        .score-badge { position: absolute; top: 20px; right: 20px; background: var(--secondary); padding: 5px 15px; border-radius: 20px; font-weight: bold; border: 2px solid var(--accent); }

        /* Camera & Analysis */
        #webcam-container { border: 4px dashed var(--primary); border-radius: 15px; width: 100%; height: 250px; background: #eee; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        #webcam-container img { width: 100%; height: 100%; object-fit: cover; }
        
        .result-box { border: 3px solid var(--primary); background: #E8F5E9; padding: 15px; border-radius: 15px; margin: 15px 0; }
        .analyzing { font-style: italic; color: var(--accent); }

        /* History */
        .history-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px; }
        .history-item { display: flex; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: left; align-items: center; }
        .history-item img { width: 80px; height: 80px; object-fit: cover; }
        .history-info { padding: 10px; font-size: 13px; }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
    </style>
</head>
<body>

<div class="container">
    <div id="page-role" class="card">
        <h1>Eco Snap AI ‚ôªÔ∏è</h1>
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
        <button onclick="showPage('page-login-student')">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
        <button onclick="showPage('page-login-teacher')" class="secondary">‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</button>
    </div>

    <div id="page-login-student" class="card hidden">
        <button class="back-btn" onclick="showPage('page-role')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
        <input type="text" id="std-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
        <input type="number" id="std-id" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 5 ‡∏´‡∏•‡∏±‡∏Å" oninput="validateStudentForm()">
        <select id="std-room" onchange="validateStudentForm()">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
            <script>
                const rooms = ['1/1','1/2','1/3','1/4','1/5','2/1','2/2','2/3','2/4','2/5','3/1','3/2','3/3','3/4','4/1','4/2','4/3','5/1','5/2','5/3','5/4','6/1','6/2','6/3'];
                rooms.forEach(r => document.write(`<option value="${r}">${r}</option>`));
            </script>
        </select>
        <button id="btn-login-std" disabled onclick="loginStudent()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div id="page-student-main" class="hidden">
        <button class="back-btn" onclick="showPage('page-role')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <div class="score-badge">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span id="display-score">0</span></div>
        <div class="card" style="margin-top: 60px;">
            <h2 id="display-name" style="margin: 0; font-size: 18px;">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
            <p id="display-room" style="margin: 0; color: #666;">‡∏´‡πâ‡∏≠‡∏á: -</p>
            <hr>
            <h3>Eco Snap AI</h3>
            <div id="webcam-container">
                <span id="placeholder-text">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏¢‡∏∞‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</span>
                <img id="preview-img" class="hidden">
            </div>
            <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleImage(event)">
            <button onclick="document.getElementById('file-input').click()">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û / ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>
            
            <div id="analysis-section" class="hidden">
                <div id="status-text" class="analyzing hidden">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</div>
                <div id="result-area" class="result-box hidden">
                    <strong>‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</strong>
                    <div id="waste-type" style="font-size: 20px; color: var(--primary); font-weight: bold;">-</div>
                    <div id="confidence-score">-</div>
                </div>
                <button id="btn-analyze" onclick="analyzeImage()">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡∏¢‡∏∞</button>
                <button id="btn-save" class="hidden" onclick="saveTrash()">‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
            </div>
        </div>

        <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡πÅ‡∏¢‡∏Å</h3>
        <div id="student-history" class="history-grid"></div>
    </div>

    <div id="page-login-teacher" class="card hidden">
        <button class="back-btn" onclick="showPage('page-role')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <h2>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</h2>
        <input type="password" id="teacher-pwd" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô">
        <button onclick="loginTeacher()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div id="page-teacher-main" class="hidden">
        <button class="back-btn" onclick="showPage('page-role')">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <div class="card">
            <h1>Eco Points üèÜ</h1>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™...">
                <button style="width: 80px;" onclick="renderLeaderboard()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
            </div>
            <select id="filter-room" onchange="renderLeaderboard()">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                <script>rooms.forEach(r => document.write(`<option value="${r}">${r}</option>`));</script>
            </select>
            
            <div id="leaderboard-container">
                <table>
                    <thead>
                        <tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th></tr>
                    </thead>
                    <tbody id="leaderboard-body"></tbody>
                </table>
            </div>
        </div>
        
        <div id="teacher-history-view" class="card hidden">
            <h3 id="viewing-name">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á -</h3>
            <div id="teacher-history-list" class="history-grid"></div>
            <button onclick="document.getElementById('teacher-history-view').classList.add('hidden')">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ</button>
        </div>
    </div>
</div>

<script>
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/UQwja1MPO/";
    let model, maxPredictions;
    let currentUser = null;
    let currentImageBase64 = null;
    let currentAnalysis = null;

    // Load Model
    async function initModel() {
        const modelURL = MODEL_URL + "model.json";
        const metadataURL = MODEL_URL + "metadata.json";
        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();
    }
    initModel();

    // Navigation
    function showPage(pageId) {
        document.querySelectorAll('.container > div').forEach(div => div.classList.add('hidden'));
        document.getElementById(pageId).classList.remove('hidden');
        window.scrollTo(0,0);
    }

    // Validation
    function validateStudentForm() {
        const name = document.getElementById('std-name').value;
        const id = document.getElementById('std-id').value;
        const room = document.getElementById('std-room').value;
        document.getElementById('btn-login-std').disabled = !(name && id.length === 5 && room);
    }

    // Student Logic
    function loginStudent() {
        const id = document.getElementById('std-id').value;
        const name = document.getElementById('std-name').value;
        const room = document.getElementById('std-room').value;
        
        let users = JSON.parse(localStorage.getItem('eco_users') || '{}');
        if(!users[id]) {
            users[id] = { name, room, score: 0, history: [] };
        }
        currentUser = { ...users[id], id };
        localStorage.setItem('eco_users', JSON.stringify(users));
        
        updateStudentUI();
        showPage('page-student-main');
    }

    function updateStudentUI() {
        document.getElementById('display-name').innerText = currentUser.name;
        document.getElementById('display-room').innerText = "‡∏´‡πâ‡∏≠‡∏á: " + currentUser.room;
        document.getElementById('display-score').innerText = currentUser.score;
        renderHistory('student-history', currentUser.history);
    }

    function handleImage(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            currentImageBase64 = event.target.result;
            const img = document.getElementById('preview-img');
            img.src = currentImageBase64;
            img.classList.remove('hidden');
            document.getElementById('placeholder-text').classList.add('hidden');
            document.getElementById('analysis-section').classList.remove('hidden');
            document.getElementById('result-area').classList.add('hidden');
            document.getElementById('btn-analyze').classList.remove('hidden');
            document.getElementById('btn-save').classList.add('hidden');
        };
        reader.readAsDataURL(file);
    }

    async function analyzeImage() {
        document.getElementById('status-text').classList.remove('hidden');
        document.getElementById('btn-analyze').classList.add('hidden');
        
        const imgElement = document.getElementById('preview-img');
        const prediction = await model.predict(imgElement);
        
        // Find best match
        let bestMatch = { className: "", probability: 0 };
        prediction.forEach(p => {
            if(p.probability > bestMatch.probability) bestMatch = p;
        });

        currentAnalysis = {
            type: bestMatch.className,
            conf: (bestMatch.probability * 100).toFixed(2)
        };

        setTimeout(() => {
            document.getElementById('status-text').classList.add('hidden');
            document.getElementById('result-area').classList.remove('hidden');
            document.getElementById('waste-type').innerText = currentAnalysis.type;
            document.getElementById('confidence-score').innerText = `‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: ${currentAnalysis.conf}%`;
            document.getElementById('btn-save').classList.remove('hidden');
        }, 1500);
    }

    function saveTrash() {
        const now = new Date();
        const record = {
            img: currentImageBase64,
            type: currentAnalysis.type,
            conf: currentAnalysis.conf,
            date: now.toLocaleDateString(),
            time: now.toLocaleTimeString()
        };

        // Update LocalStorage
        let users = JSON.parse(localStorage.getItem('eco_users'));
        users[currentUser.id].score += 1;
        users[currentUser.id].history.unshift(record);
        localStorage.setItem('eco_users', JSON.stringify(users));

        // Update Current Session
        currentUser.score += 1;
        currentUser.history.unshift(record);

        // Reset UI
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! +1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô");
        document.getElementById('preview-img').classList.add('hidden');
        document.getElementById('placeholder-text').classList.remove('hidden');
        document.getElementById('analysis-section').classList.add('hidden');
        updateStudentUI();
    }

    function renderHistory(elementId, history) {
        const container = document.getElementById(elementId);
        container.innerHTML = history.length === 0 ? '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>' : '';
        history.forEach(item => {
            container.innerHTML += `
                <div class="history-item">
                    <img src="${item.img}">
                    <div class="history-info">
                        <strong>${item.type}</strong> (${item.conf}%)<br>
                        <small>${item.date} | ${item.time}</small>
                    </div>
                </div>
            `;
        });
    }

    // Teacher Logic
    function loginTeacher() {
        const pwd = document.getElementById('teacher-pwd').value;
        if(pwd === "Eco2026") {
            showPage('page-teacher-main');
            renderLeaderboard();
        } else {
            alert("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        }
    }

    function renderLeaderboard() {
        const users = JSON.parse(localStorage.getItem('eco_users') || '{}');
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        const filterRoom = document.getElementById('filter-room').value;
        
        let userList = Object.keys(users).map(id => ({ ...users[id], id }));
        
        // Filter
        userList = userList.filter(u => {
            const matchSearch = u.name.toLowerCase().includes(searchTerm) || u.id.includes(searchTerm);
            const matchRoom = filterRoom === "" || u.room === filterRoom;
            return matchSearch && matchRoom;
        });

        // Sort
        userList.sort((a, b) => b.score - a.score);

        const tbody = document.getElementById('leaderboard-body');
        tbody.innerHTML = "";
        userList.forEach(u => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td onclick="viewStudentDetail('${u.id}')" style="color:blue; text-decoration:underline; cursor:pointer">${u.name}</td>
                <td>${u.room}</td>
                <td>${u.score}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function viewStudentDetail(id) {
        const users = JSON.parse(localStorage.getItem('eco_users'));
        const user = users[id];
        document.getElementById('teacher-history-view').classList.remove('hidden');
        document.getElementById('viewing-name').innerText = `‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á ${user.name}`;
        renderHistory('teacher-history-list', user.history);
        window.scrollTo(0, document.body.scrollHeight);
    }
</script>

</body>
</html>
