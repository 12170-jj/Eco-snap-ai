<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Eco Snap AI</title>

<!-- Tensorflow + Teachable Machine -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  margin:0;
  font-family: "Segoe UI", sans-serif;
  background:#e8f5e9;
}
.hidden{display:none}
.page{padding:20px}
.card{
  background:#fff;
  border-radius:16px;
  padding:20px;
  margin-bottom:20px;
}
button{
  width:100%;
  padding:15px;
  border:none;
  border-radius:30px;
  font-size:16px;
  cursor:pointer;
}
.green{background:#2e7d32;color:#fff}
.gold{color:#d4af37;font-weight:bold}
input,select{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:10px;
  border:1px solid #ccc;
}
.score{
  position:fixed;
  top:10px;
  right:15px;
  background:#2e7d32;
  color:#fff;
  padding:8px 14px;
  border-radius:20px;
}
.image-box{
  height:220px;
  background:#c8e6c9;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.image-box img{
  max-width:100%;
  max-height:100%;
}
</style>
</head>

<body>

<!-- PAGE 1 : ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó -->
<div id="page-role" class="page">
  <h1>üå± Eco Snap AI</h1>
  <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
  <button class="green" onclick="chooseRole('student')">üë©‚Äçüéì ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button><br><br>
  <button class="green" onclick="chooseRole('teacher')">üë®‚Äçüè´ ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</button>
</div>

<!-- PAGE 2 : Login -->
<div id="page-login" class="page hidden">
  <div class="card">
    <h3 id="login-title"></h3>
    <input id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
    <input id="studentId" placeholder="‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß">
    <select id="room">
      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
      <option>1/1</option><option>1/2</option><option>1/3</option><option>1/4</option><option>1/5</option>
      <option>2/1</option><option>2/2</option><option>2/3</option><option>2/4</option><option>2/5</option>
      <option>3/1</option><option>3/2</option><option>3/3</option><option>3/4</option>
      <option>4/1</option><option>4/2</option><option>4/3</option>
      <option>5/1</option><option>5/2</option><option>5/3</option><option>5/4</option>
      <option>6/1</option><option>6/2</option><option>6/3</option>
    </select>
    <input id="teacherCode" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏£‡∏π)" type="password">
    <button class="green" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>
</div>

<!-- PAGE 3 : Student -->
<div id="page-student" class="page hidden">
  <div class="score">‚≠ê <span id="score">0</span></div>

  <div class="card">
    <div class="image-box">
      <span id="imgText">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</span>
      <img id="preview" class="hidden">
    </div>
    <input type="file" accept="image/*" id="imageInput">
  </div>

  <div class="card">
    <button class="green" onclick="analyze()">üß† ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
    <button onclick="finish()">‚úÖ ‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
    <div id="result"></div>
  </div>

  <div class="card">
    <h3>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h3>
    <div id="history"></div>
  </div>
</div>

<!-- PAGE 4 : Teacher -->
<div id="page-teacher" class="page hidden">
  <div class="card">
    <input id="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏ä‡∏∑‡πà‡∏≠ / ‡πÄ‡∏•‡∏Ç‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" oninput="renderTeacher()">
    <select id="filterRoom" onchange="renderTeacher()">
      <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>
      <option>1/1</option><option>1/2</option><option>1/3</option><option>1/4</option><option>1/5</option>
      <option>2/1</option><option>2/2</option><option>2/3</option><option>2/4</option><option>2/5</option>
      <option>3/1</option><option>3/2</option><option>3/3</option><option>3/4</option>
      <option>4/1</option><option>4/2</option><option>4/3</option>
      <option>5/1</option><option>5/2</option><option>5/3</option><option>5/4</option>
      <option>6/1</option><option>6/2</option><option>6/3</option>
    </select>
  </div>

  <div class="card">
    <h3>üèÜ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
    <div id="teacherList"></div>
  </div>
</div>

<script>
// ================= Firebase =================
const firebaseConfig = {
  // üî• ‡πÉ‡∏™‡πà config ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ò‡∏≠‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ================= Global =================
let role="", currentUser={}, model;
const URL="https://teachablemachine.withgoogle.com/models/UQwja1MPO/";

// ================= Role =================
function chooseRole(r){
  role=r;
  page("page-login");
  document.getElementById("login-title").innerText =
    r==="student"?"‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô":"‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏π";
}

// ================= Login =================
function login(){
  if(role==="teacher"){
    if(document.getElementById("teacherCode").value!=="Eco2026"){
      alert("‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); return;
    }
    page("page-teacher");
    renderTeacher();
  }else{
    currentUser={
      name:name.value,
      id:studentId.value,
      room:room.value,
      score:0,
      history:[]
    };
    if(!currentUser.name||!currentUser.id||!currentUser.room){
      alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");return;
    }
    db.ref("users/"+currentUser.id).set(currentUser);
    page("page-student");
  }
}

// ================= Student AI =================
async function loadModel(){
  if(!model) model=await tmImage.load(URL+"model.json",URL+"metadata.json");
}

imageInput.onchange=()=>{
  const f=imageInput.files[0];
  const r=new FileReader();
  r.onload=()=>{
    preview.src=r.result;
    preview.classList.remove("hidden");
    imgText.style.display="none";
  };
  r.readAsDataURL(f);
};

async function analyze(){
  if(!imageInput.files[0]) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô");
  await loadModel();
  const p=await model.predict(preview);
  p.sort((a,b)=>b.probability-a.probability);
  result.innerHTML=`${p[0].className} (${(p[0].probability*100).toFixed(1)}%)`;
}

function finish(){
  if(!preview.src) return;
  currentUser.score++;
  score.innerText=currentUser.score;
  currentUser.history.push({
    img:preview.src,
    result:result.innerText,
    time:new Date().toLocaleString()
  });
  db.ref("users/"+currentUser.id).set(currentUser);
  renderHistory();
  imageInput.value="";
  preview.classList.add("hidden");
  imgText.style.display="block";
  result.innerHTML="";
}

// ================= History =================
function renderHistory(){
  history.innerHTML="";
  currentUser.history.forEach(h=>{
    history.innerHTML+=`
      <div>
        <img src="${h.img}" width="80"><br>
        ${h.result}<br>${h.time}
      </div><hr>`;
  });
}

// ================= Teacher =================
function renderTeacher(){
  db.ref("users").once("value",s=>{
    let users=Object.values(s.val()||{});
    const q=search.value.toLowerCase();
    const r=filterRoom.value;
    users=users.filter(u=>
      (!q||u.name.toLowerCase().includes(q)||u.id.includes(q)) &&
      (!r||u.room===r)
    );
    users.sort((a,b)=>b.score-a.score);
    teacherList.innerHTML="";
    users.forEach((u,i)=>{
      teacherList.innerHTML+=`
        <div class="${i<3?'gold':''}">
          ${i+1}. ${u.id} ${u.name} ‚Äî ${u.score}
        </div>`;
    });
  });
}

// ================= Page =================
function page(id){
  document.querySelectorAll(".page").forEach(p=>p.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}
</script>

</body>
</html>
